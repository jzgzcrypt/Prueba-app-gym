<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard de Entrenamiento — Optimizado</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
  body{ -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  .sidebar{transition:transform .28s ease;}
  @media (max-width:767px){ .sidebar-hidden{transform:translateX(-100%);} }
  .section{display:none;} .section.active{display:block;}
  .card{transition:transform .18s ease,box-shadow .18s ease}
  .card:hover{transform:translateY(-4px);box-shadow:0 10px 20px rgba(2,6,23,.06);}
  .drag-over{background-color:rgba(59,130,246,.06);border:2px dashed rgba(59,130,246,.18);}
  canvas{display:block;height:240px !important;max-height:360px;}
  
  /* Toast Notifications */
  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #10b981;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    z-index: 1000;
    animation: slideIn 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  .toast.error { background: #ef4444; }
  .toast.warning { background: #f59e0b; }
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  /* Loading States */
  .loading {
    opacity: 0.6;
    pointer-events: none;
  }
  .loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid #3b82f6;
    border-top: 2px solid transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Quick Entry Styles */
  .quick-entry {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    padding: 24px;
    color: white;
  }
  .quick-entry input, .quick-entry select {
    background: rgba(255,255,255,0.9);
    border: none;
    border-radius: 8px;
    padding: 12px;
    color: #1f2937;
  }
  .quick-entry input:focus, .quick-entry select:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
  }
  
  /* Success States */
  .success {
    background: #10b981 !important;
    color: white !important;
    border-color: #059669 !important;
  }
  
  /* Simplified Table */
  .simplified-table {
    font-size: 14px;
  }
  .simplified-table th {
    background: #f8fafc;
    font-weight: 600;
    color: #374151;
  }
</style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 font-sans text-gray-800">
<div class="flex min-h-screen">
  <aside id="sidebar" class="sidebar fixed top-0 left-0 w-64 bg-gradient-to-b from-gray-800 to-gray-900 text-white h-full p-6 z-30 md:translate-x-0 sidebar-hidden">
    <h3 class="text-xl font-bold mb-6 text-center">Mi Progreso</h3>
    <nav class="space-y-2 text-sm">
      <a href="#dashboard" data-section="dashboard" class="block py-2 px-3 rounded hover:bg-gray-700 transition-colors">📊 Dashboard</a>
      <a href="#registro-pesos" data-section="registro-pesos" class="block py-2 px-3 rounded hover:bg-gray-700 transition-colors">🏋️ Registro Pesos</a>
      <a href="#registro-cardio" data-section="registro-cardio" class="block py-2 px-3 rounded hover:bg-gray-700 transition-colors">🏃 Registro Cardio</a>
      <a href="#pautas-dieta" data-section="pautas-dieta" class="block py-2 px-3 rounded hover:bg-gray-700 transition-colors">🥗 Pautas Dieta</a>
    </nav>
  </aside>

  <main class="flex-1 ml-0 md:ml-64 p-6">
    <button id="btn-menu" class="md:hidden mb-4 p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">☰ Menú</button>

    <section id="dashboard" class="section active">
      <h1 class="text-3xl font-bold text-center mb-6">Mi Dashboard</h1>
      
      <!-- QUICK ENTRY FORM - NUEVA FUNCIONALIDAD -->
      <div class="quick-entry mb-6">
        <h2 class="text-xl font-bold mb-4 text-center">Entrada Rápida de Hoy</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium mb-2">Peso (kg)</label>
            <input type="number" id="quick-weight" step="0.1" placeholder="85.0" class="w-full">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Entrenamiento</label>
            <select id="quick-workout" class="w-full">
              <option value="">Seleccionar...</option>
              <option value="Pull">🏋️ Pull</option>
              <option value="Push">💪 Push</option>
              <option value="Piernas">🦵 Piernas</option>
              <option value="Cardio">🏃 Cardio</option>
              <option value="Descanso">😴 Descanso</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Cardio (km)</label>
            <input type="number" id="quick-cardio" step="0.1" placeholder="3.5" class="w-full">
          </div>
          <div class="flex items-end">
            <button id="quick-save" class="w-full bg-white text-purple-600 py-3 px-4 rounded-lg font-semibold hover:bg-gray-100 transition-colors">
              💾 Guardar Todo
            </button>
          </div>
        </div>
        <div id="quick-status" class="mt-3 text-center text-sm opacity-0 transition-opacity"></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="card bg-white p-6 rounded-xl shadow">
          <h2 class="text-lg font-semibold mb-4">Progreso General</h2>
          <div class="flex items-center justify-center">
            <div class="relative w-28 h-28">
              <svg viewBox="0 0 100 100" class="w-28 h-28 -rotate-90">
                <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"></circle>
                <circle id="progress-circle" cx="50" cy="50" r="40" stroke="#3b82f6" stroke-width="8" fill="none" stroke-linecap="round" stroke-dasharray="0 251"></circle>
              </svg>
              <div class="absolute inset-0 flex items-center justify-center">
                <span id="progress-percentage" class="text-xl font-bold text-blue-600">0%</span>
              </div>
            </div>
          </div>
          <p id="days-elapsed" class="text-center text-sm text-gray-600 mt-3">Día 1 de 42</p>
        </div>

        <div class="card bg-white p-6 rounded-xl shadow">
          <h2 class="text-lg font-semibold mb-4">Estado Actual</h2>
          <div class="space-y-3">
            <div class="flex justify-between"><span class="text-sm text-gray-600">Peso</span><span id="estado-peso-display" class="font-bold">85.0 kg</span></div>
            <div class="flex justify-between"><span class="text-sm text-gray-600">Cintura</span><span id="estado-cintura-display" class="font-bold">? cm</span></div>
            <div class="w-full bg-gray-200 rounded-full h-2 mt-3"><div id="peso-progress-bar" class="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full transition-all duration-500" style="width:0%"></div></div>
          </div>
        </div>

        <div class="card bg-white p-6 rounded-xl shadow">
          <h2 class="text-lg font-semibold mb-4">To-Do Hoy</h2>
          <div id="todo-list" class="space-y-3"></div>
          <div class="mt-3">
            <div class="flex justify-between"><span class="text-sm text-gray-600">Completado</span><span id="adherencia-porcentaje" class="font-bold text-green-600">0%</span></div>
            <div class="w-full bg-gray-200 rounded-full h-3 mt-2"><div id="adherencia-bar" class="bg-gradient-to-r from-green-500 to-green-600 h-3 rounded-full transition-all duration-500" style="width:0%"></div></div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="card bg-white p-6 rounded-xl shadow" style="min-height:240px">
          <h3 class="font-semibold mb-3">Evolución del Peso</h3>
          <canvas id="peso-chart" height="240"></canvas>
        </div>
        <div class="card bg-white p-6 rounded-xl shadow" style="min-height:240px">
          <h3 class="font-semibold mb-3">Adherencia Semanal</h3>
          <canvas id="adherencia-chart" height="240"></canvas>
        </div>
      </div>

      <div class="card bg-white p-6 rounded-xl shadow mb-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold">Planificación Semanal</h3>
          <button id="reset-plan" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 transition-colors">🔄 Reset</button>
        </div>
        <div id="calendar-semanal" class="grid grid-cols-1 md:grid-cols-7 gap-3"></div>
        <p class="text-xs text-gray-500 mt-3">Arrastra actividades. Colores: 🔵 Pull · 🟢 Push · 🟡 Piernas · 🔴 Cardio · ⚪ Descanso</p>
      </div>
    </section>

    <section id="registro-pesos" class="section">
      <h1 class="text-2xl font-bold mb-4">Registro de Pesos</h1>
      
      <!-- Filtros Simplificados -->
      <div class="flex gap-4 mb-4">
        <div>
          <label class="text-sm font-medium">Microciclo</label>
          <select id="filtro-microciclo" class="mt-1 p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="all">Todos</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>Descarga</option>
          </select>
        </div>
        <div>
          <label class="text-sm font-medium">Día</label>
          <select id="filtro-dia" class="mt-1 p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="all">Todos</option>
          </select>
        </div>
        <div class="flex items-end">
          <button id="btn-simplified-view" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
            📊 Vista Simplificada
          </button>
        </div>
      </div>
      
      <!-- Tabla Simplificada -->
      <div class="bg-white p-4 rounded shadow mb-6 overflow-x-auto">
        <table id="tabla-pesos" class="min-w-full border simplified-table">
          <thead>
            <tr class="bg-blue-600 text-white text-sm">
              <th class="p-2">Ejercicio</th>
              <th class="p-2">Peso</th>
              <th class="p-2">Reps</th>
              <th class="p-2">Estado</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="registro-cardio" class="section">
      <h1 class="text-2xl font-bold mb-4">Registro de Cardio</h1>
      <div class="mb-4">
        <label class="text-sm font-medium">Microciclo</label>
        <select id="filtro-microciclo-cardio" class="mt-1 p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <option value="all">Todos</option>
          <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>Descarga</option>
        </select>
      </div>
      <div class="bg-white p-4 rounded shadow mb-6 overflow-x-auto">
        <table id="tabla-cardio" class="min-w-full border simplified-table">
          <thead>
            <tr class="bg-blue-600 text-white text-sm">
              <th class="p-2">Fecha</th>
              <th class="p-2">Sesión</th>
              <th class="p-2">KM</th>
              <th class="p-2">Tiempo</th>
              <th class="p-2">Estado</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="pautas-dieta" class="section">
      <h1 class="text-2xl font-bold mb-4">Pautas de Dieta</h1>
      <div class="bg-white p-4 rounded shadow mb-6">
        <form id="form-dieta" class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <input type="date" id="fecha-dieta" value="2025-08-11" class="p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          <input type="number" id="calorias-dieta" placeholder="Calorías" class="p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          <input type="number" id="proteinas-dieta" placeholder="Proteínas (g)" class="p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          <input type="number" id="carbos-dieta" placeholder="Carbohidratos (g)" class="p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          <input type="number" id="grasas-dieta" placeholder="Grasas (g)" class="p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          <div class="flex items-center gap-2">
            <input type="checkbox" id="ayuno-dieta" class="rounded focus:ring-2 focus:ring-blue-500">
            <label>Ayuno 16/8</label>
          </div>
          <div class="md:col-span-3 flex gap-2">
            <button type="button" id="btn-guardar-dieta" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors">Guardar Dieta</button>
            <button type="button" id="btn-export" class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300 transition-colors">Export JSON</button>
          </div>
        </form>
      </div>
      <div class="bg-white p-4 rounded shadow overflow-x-auto">
        <table id="tabla-dieta" class="min-w-full border simplified-table">
          <thead>
            <tr class="bg-blue-600 text-white text-sm">
              <th class="p-2">Fecha</th>
              <th class="p-2">Calorías</th>
              <th class="p-2">Proteínas</th>
              <th class="p-2">Estado</th>
              <th class="p-2">Feedback</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<!-- Toast Container -->
<div id="toast-container"></div>

<script>
/* data (mesociclo completo kept) */
const mesociclo = {
  'Día 1: Pull': [
    { ejercicio: 'Bent over rows con mancuernas', sets: [{ tipo: 'Top', peso: 30, reps: '8-10' }, { tipo: 'Resto', peso: 25, reps: '10-12', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Jalón polea alta pecho apoyado unilateral', sets: [{ tipo: 'Normal', peso: 10, reps: '8-10', count: 3 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Remo polea pecho apoyado unilateral', sets: [{ tipo: 'Normal', peso: 10, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Face pull polea alta boca arriba', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Low cable rear delt row', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Curl alterno con mancuernas', sets: [{ tipo: 'Top', peso: 10, reps: '6-8' }, { tipo: 'Resto', peso: 10, reps: '10-12', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Curl bayesian en polea', sets: [{ tipo: 'Normal', peso: 10, reps: '10-12', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Crunch abdominal en polea alta', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] }
  ],
  'Día 2: Push': [
    { ejercicio: 'Press inclinado multipower 45º', sets: [{ tipo: 'Top', peso: 35, reps: '5-7' }, { tipo: 'Resto', peso: 30, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Contractora pectoral máquina inclinada', sets: [{ tipo: 'Normal', peso: 10, reps: '10-12', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Press en máquina', sets: [{ tipo: 'Normal', peso: 10, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Elevaciones laterales polea con muñequera', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Elevaciones laterales mancuernas', sets: [{ tipo: 'Normal', peso: 10, reps: '>15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Press francés mancuernas', sets: [{ tipo: 'Top', peso: 10, reps: '8-10' }, { tipo: 'Resto', peso: 10, reps: '10-12', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Extensión tríceps katana polea baja', sets: [{ tipo: 'Normal', peso: 10, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Crunch abdominal en polea alta', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] }
  ],
  'Día 3: Piernas': [
    { ejercicio: 'Aducción de cadera en máquina', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Prensa 45º', sets: [{ tipo: 'Top', peso: 10, reps: '6-8' }, { tipo: 'Resto', peso: 10, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Sentadilla búlgara (énfasis glúteo)', sets: [{ tipo: 'Top', peso: 20, reps: '6-8' }, { tipo: 'Resto', peso: 15, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Curl femoral en máquina', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Extensión de rodilla en máquina', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Elevaciones de talones en máquina', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] }
  ],
  'Día 4: Pull': [
    { ejercicio: 'Bent over rows con mancuernas', sets: [{ tipo: 'Top', peso: 30, reps: '6-8' }, { tipo: 'Resto', peso: 25, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Jalón polea alta pecho apoyado unilateral', sets: [{ tipo: 'Normal', peso: 10, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Máquina remo espalda alta', sets: [{ tipo: 'Normal', peso: 10, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Pullover polea alta rodillas banco 60º', sets: [{ tipo: 'Normal', peso: 10, reps: '8-12', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Face pull polea alta boca arriba', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Low cable rear delt row', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Curl barra Z', sets: [{ tipo: 'Top', peso: 10, reps: '6-8' }, { tipo: 'Resto', peso: 10, reps: '10-12', count: 1 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Curl bayesian en polea', sets: [{ tipo: 'Normal', peso: 10, reps: '10-12', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Ab wheel', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] }
  ],
  'Día 5: Push': [
    { ejercicio: 'Press inclinado multipower 30º', sets: [{ tipo: 'Top', peso: 35, reps: '6-8' }, { tipo: 'Resto', peso: 30, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Contractora pectoral en máquina', sets: [{ tipo: 'Normal', peso: 10, reps: '10-12', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Press militar mancuernas banco inclinado', sets: [{ tipo: 'Top', peso: 10, reps: '7-9' }, { tipo: 'Resto', peso: 10, reps: '9-11', count: 1 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Elevaciones laterales polea con muñequera', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 3 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Elevaciones laterales mancuernas', sets: [{ tipo: 'Normal', peso: 10, reps: '>15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Press francés barra Z 30º', sets: [{ tipo: 'Top', peso: 10, reps: '8-10' }, { tipo: 'Resto', peso: 10, reps: '10-12', count: 1 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Extensión tríceps katana polea baja', sets: [{ tipo: 'Normal', peso: 10, reps: '8-10', count: 3 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Crunch abdominal en polea alta', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] }
  ],
  'Cardio': [
    { microciclo: 1, sesiones: [
        { id: 1, plan: '25 min (15 min trote 6:30-7:00 min/km + 5 min intervalos [1 min 5:30 / 1 min caminando x3] + 5 min calentamiento/enfriamiento)', km: 3.5 },
        { id: 2, plan: '25 min (igual)', km: 3.5 },
        { id: 3, plan: '25 min (igual)', km: 3.5 }
    ]},
    { microciclo: 2, sesiones: [
        { id: 1, plan: '25 min (15 min trote 6:15-6:45)', km: 3.5 }, { id: 2, plan: '25 min', km: 3.5 }, { id: 3, plan: '25 min', km: 3.5 }
    ]},
    { microciclo: 3, sesiones: [
        { id: 1, plan: '25 min (intervalos 5:00)', km: 3.5 }, { id: 2, plan: '25 min', km: 3.5 }, { id: 3, plan: '25 min', km: 3.5 }
    ]},
    { microciclo: 4, sesiones: [
        { id: 1, plan: '27 min (15 min trote 6:00-6:30 + intervalos)', km: 4 }, { id: 2, plan: '27 min', km: 4 }, { id: 3, plan: '27 min', km: 4 }
    ]},
    { microciclo: 5, sesiones: [
        { id: 1, plan: '30 min (intervalos 4:45)', km: 4.5 }, { id: 2, plan: '30 min', km: 4.5 }, { id: 3, plan: '30 min', km: 4.5 }
    ]},
    { microciclo: 'Descarga', sesiones: [
        { id: 1, plan: '20 min trote ligero', km: 3 }, { id: 2, plan: '20 min', km: 3 }, { id: 3, plan: '20 min', km: 3 }
    ]}
  ]
};

/* minimal state helpers */
let estado = JSON.parse(localStorage.getItem('estado')) || [];
let pesos = JSON.parse(localStorage.getItem('pesos')) || [];
let cardio = JSON.parse(localStorage.getItem('cardio')) || [];
let dieta = JSON.parse(localStorage.getItem('dieta')) || [];
let planSemanal = JSON.parse(localStorage.getItem('planSemanal')) || [
  { dia: 'Lunes', tareas: ['Día 1: Pull', 'Cardio'] },
  { dia: 'Martes', tareas: ['Día 2: Push', 'Cardio'] },
  { dia: 'Miércoles', tareas: ['Día 3: Piernas'] },
  { dia: 'Jueves', tareas: ['Descanso'] },
  { dia: 'Viernes', tareas: ['Día 4: Pull', 'Cardio'] },
  { dia: 'Sábado', tareas: ['Día 5: Push'] },
  { dia: 'Domingo', tareas: ['Descanso'] }
];
let adherenciaDiaria = JSON.parse(localStorage.getItem('adherenciaDiaria')) || {};

const q=(s,d=document)=>d.querySelector(s), qa=(s,d=document)=>Array.from(d.querySelectorAll(s));
const todayISO=()=>new Date().toISOString().split('T')[0];
const daysName=['Domingo','Lunes','Martes','Miércoles','Jueves','Viernes','Sábado'];
const getTodayName=(d=new Date())=>daysName[d.getDay()];
const saveAll=()=>{ localStorage.setItem('estado',JSON.stringify(estado)); localStorage.setItem('pesos',JSON.stringify(pesos)); localStorage.setItem('cardio',JSON.stringify(cardio)); localStorage.setItem('dieta',JSON.stringify(dieta)); localStorage.setItem('planSemanal',JSON.stringify(planSemanal)); localStorage.setItem('adherenciaDiaria',JSON.stringify(adherenciaDiaria)); };

/* NUEVAS FUNCIONALIDADES - Toast Notifications */
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  
  const container = q('#toast-container');
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease forwards';
    setTimeout(() => container.removeChild(toast), 300);
  }, 3000);
}

/* NUEVAS FUNCIONALIDADES - Loading States */
function setLoading(element, isLoading) {
  if (isLoading) {
    element.classList.add('loading');
    element.style.position = 'relative';
  } else {
    element.classList.remove('loading');
  }
}

/* NUEVAS FUNCIONALIDADES - Quick Entry */
function handleQuickSave() {
  const weight = parseFloat(q('#quick-weight').value);
  const workout = q('#quick-workout').value;
  const cardioKm = parseFloat(q('#quick-cardio').value);
  
  // Validación en tiempo real
  let hasData = false;
  let savedItems = [];
  
  if (weight && weight > 0) {
    guardarPesajeHoy(weight);
    savedItems.push('Peso');
    hasData = true;
  }
  
  if (workout && workout !== 'Descanso') {
    actualizarAdherenciaTask('pesos', true);
    savedItems.push('Entrenamiento');
    hasData = true;
  }
  
  if (cardioKm && cardioKm > 0) {
    // Guardar cardio rápido
    const fecha = todayISO();
    cardio = cardio.filter(c => c.fecha !== fecha);
    cardio.push({
      fecha,
      microciclo: 1,
      sesionId: 1,
      km: cardioKm,
      tiempo: Math.round(cardioKm * 7), // Estimación de tiempo
      ritmo: Math.round(cardioKm * 7) / cardioKm,
      calorias: Math.round(cardioKm * 7 * 10)
    });
    actualizarAdherenciaTask('cardio', true);
    savedItems.push('Cardio');
    hasData = true;
  }
  
  if (hasData) {
    saveAll();
    showToast(`✅ Guardado: ${savedItems.join(', ')}`);
    
    // Limpiar formulario
    q('#quick-weight').value = '';
    q('#quick-workout').value = '';
    q('#quick-cardio').value = '';
    
    // Actualizar UI
    actualizarProgresoGeneral();
    actualizarTodoList();
    actualizarGraficoPeso();
    actualizarGraficoAdherencia();
  } else {
    showToast('⚠️ Introduce al menos un dato', 'warning');
  }
}

/* NUEVAS FUNCIONALIDADES - Validación en Tiempo Real */
function setupRealTimeValidation() {
  const inputs = qa('input[type="number"]');
  inputs.forEach(input => {
    input.addEventListener('input', (e) => {
      const value = parseFloat(e.target.value);
      const min = parseFloat(e.target.min) || 0;
      const max = parseFloat(e.target.max) || 999;
      
      if (value < min || value > max) {
        e.target.classList.add('border-red-500');
        e.target.classList.remove('border-green-500');
      } else {
        e.target.classList.remove('border-red-500');
        e.target.classList.add('border-green-500');
      }
    });
  });
}

/* UI wiring */
document.getElementById('btn-menu').addEventListener('click',()=>document.getElementById('sidebar').classList.toggle('sidebar-hidden'));
window.addEventListener('DOMContentLoaded',()=>{ if(window.innerWidth>=768) document.getElementById('sidebar').classList.remove('sidebar-hidden'); });

qa('a[data-section]').forEach(a=>a.addEventListener('click',e=>{
  e.preventDefault(); showSection(a.dataset.section);
  if(window.innerWidth<768) document.getElementById('sidebar').classList.add('sidebar-hidden');
}));
function showSection(id){
  qa('.section').forEach(s=>s.classList.remove('active')); q('#'+id).classList.add('active'); window.scrollTo({top:0,behavior:'smooth'});
  if(id==='registro-pesos') inicializarTablaPesos(); if(id==='registro-cardio') inicializarTablaCardio(); if(id==='pautas-dieta') inicializarTablaDieta();
}

/* progress/adherence */
function actualizarProgresoGeneral(){
  const inicio=new Date('2025-08-11'); const diasTot=42;
  const diasTrans=Math.min(Math.floor((new Date()-inicio)/(1000*60*60*24))+1,diasTot);
  q('#days-elapsed').textContent=`Día ${diasTrans} de ${diasTot}`;
  const ultimo=estado.length?estado[estado.length-1]:{peso:85,cintura:null};
  const pIni=85,pObj=80;
  const pTemp=(diasTrans/diasTot)*100; const pPeso=Math.min(((pIni-ultimo.peso)/(pIni-pObj))*100,100);
  const pTotal=Math.max(pTemp*0.3 + pPeso*0.7,0);
  const circ=2*Math.PI*40; q('#progress-circle').style.strokeDasharray=`${(pTotal/100)*circ} ${circ}`;
  q('#progress-percentage').textContent=`${Math.round(pTotal)}%`; q('#estado-peso-display').textContent=`${ultimo.peso.toFixed(1)} kg`; q('#estado-cintura-display').textContent=ultimo.cintura?`${ultimo.cintura.toFixed(1)} cm`:'? cm';
  q('#peso-progress-bar').style.width=`${Math.max(0,pPeso)}%`;
}

/* todo list (includes pesaje diario) */
function actualizarTodoList(){
  const day = todayISO(); const planHoy=planSemanal.find(p=>p.dia===getTodayName())?.tareas||[];
  const container=q('#todo-list'); container.innerHTML='';
  const items=[];
  if(planHoy.some(t=>t.includes('Pull')||t.includes('Push')||t.includes('Piernas'))) items.push({id:'pesos',label:'Entreno de Pesos'});
  if(planHoy.includes('Cardio')) items.push({id:'cardio',label:'Cardio'});
  items.push({id:'dieta',label:'Dieta (~1800 kcal)'}); items.push({id:'ayuno',label:'Ayuno 16/8'});
  
  items.forEach(t=>{
    const div=document.createElement('div'); div.className='flex items-center justify-between';
    const checked = !!(adherenciaDiaria[day]&&adherenciaDiaria[day][t.id]);
    div.innerHTML = `<label class="flex items-center gap-2"><input type="checkbox" id="todo-${t.id}" ${checked?'checked':''}> <span class="text-sm">${t.label}</span></label>`;
    container.appendChild(div);
    q(`#todo-${t.id}`).addEventListener('change', e=>{ actualizarAdherenciaTask(t.id, e.target.checked); });
  });

  const total = container.querySelectorAll('input[type="checkbox"]').length;
  let done = 0; container.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ if(cb.checked) done++; });
  const pct = total? Math.round((done/total)*100) : 0;
  q('#adherencia-porcentaje').textContent = `${pct}%`; q('#adherencia-bar').style.width = `${pct}%`;
}

function actualizarAdherenciaTask(id,val){
  const d=todayISO(); if(!adherenciaDiaria[d]) adherenciaDiaria[d]={};
  adherenciaDiaria[d][id]=!!val; saveAll(); actualizarTodoList();
  showToast(val ? `✅ ${id} completado` : `❌ ${id} desmarcado`);
}

/* guardar pesaje diario */
function guardarPesajeHoy(value){
  if(!value || isNaN(value) || value<=0){ showToast('⚠️ Ingresa un peso válido', 'error'); return; }
  const fecha=todayISO();
  estado = estado.filter(e=>e.fecha!==fecha);
  estado.push({fecha, peso: parseFloat(value), cintura: null});
  estado.sort((a,b)=>new Date(a.fecha)-new Date(b.fecha));
  saveAll();
  showToast(`✅ Peso guardado: ${value} kg`);
  actualizarProgresoGeneral(); actualizarGraficoPeso(); actualizarTodoList();
}

/* Charts (destroy/create safe) */
let pesoChart=null, adherenciaChart=null;
function crearGraficoPeso(){
  if(pesoChart){ try{ pesoChart.destroy(); }catch(e){} pesoChart=null; }
  const ctx=q('#peso-chart').getContext('2d');
  pesoChart = new Chart(ctx,{ type:'line', data:{ labels:[], datasets:[{label:'Peso', data:[], borderColor:'#3b82f6', backgroundColor:'rgba(59,130,246,.08)', tension:.3, fill:true}]}, options:{responsive:true, maintainAspectRatio:false} });
  actualizarGraficoPeso();
}
function actualizarGraficoPeso(){
  if(!pesoChart) return crearGraficoPeso();
  const labels = estado.slice(-12).map(e=>new Date(e.fecha).toLocaleDateString());
  const data = estado.slice(-12).map(e=>e.peso);
  pesoChart.data.labels = labels.length?labels:['Inicio']; pesoChart.data.datasets[0].data = data.length?data:[85]; pesoChart.update();
}
function crearGraficoAdherencia(){ if(adherenciaChart){ try{ adherenciaChart.destroy(); }catch(e){} adherenciaChart=null; } const ctx=q('#adherencia-chart').getContext('2d');
  adherenciaChart = new Chart(ctx,{ type:'bar', data:{ labels:[], datasets:[{label:'Adherencia (%)', data:[], borderRadius:4, backgroundColor:[]} ]}, options:{responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true,max:100}}} });
  actualizarGraficoAdherencia();
}
function actualizarGraficoAdherencia(){
  if(!adherenciaChart) return crearGraficoAdherencia();
  const labels=[]; const data=[];
  for(let i=6;i>=0;i--){ const d=new Date(); d.setDate(d.getDate()-i); const iso=d.toISOString().split('T')[0]; labels.push(daysName[d.getDay()].slice(0,3)); const a=adherenciaDiaria[iso]||{}; const completed=(a.pesos?1:0)+(a.cardio?1:0)+(a.dieta?1:0)+(a.ayuno?1:0); data.push(Math.round((completed/4)*100)); }
  adherenciaChart.data.labels=labels; adherenciaChart.data.datasets[0].data=data; adherenciaChart.data.datasets[0].backgroundColor = data.map(d => d>=75? '#10b981': d>=50? '#f59e0b':'#ef4444'); adherenciaChart.update();
}

/* Calendar drag/drop */
function actualizarCalendarioSemanal(){
  const calendar=q('#calendar-semanal'); calendar.innerHTML='';
  planSemanal.forEach((day,idx)=>{ const isToday=day.dia===getTodayName(); const card=document.createElement('div'); card.className=`p-3 rounded-xl ${isToday?'bg-blue-50 border-blue-200':'bg-white border-gray-200'} card`;
    card.innerHTML=`<div class="font-semibold text-center mb-2">${day.dia}${isToday?'<div class="text-xs text-blue-600">HOY</div>':''}</div><div id="slot-${idx}" class="min-h-[80px] space-y-2" ondragover="allowDrop(event)" ondrop="drop(event,${idx})"></div>`; calendar.appendChild(card);
    const slot=q(`#slot-${idx}`);
    day.tareas.forEach((t,ti)=>{ const el=document.createElement('div'); el.className=`p-2 rounded text-xs font-medium ${t==='Descanso'?'bg-gray-200': t.includes('Pull')?'bg-blue-200': t.includes('Push')?'bg-green-200': t.includes('Piernas')?'bg-yellow-200':'bg-red-200'} draggable`; el.draggable=true; el.id=`task-${idx}-${ti}`; el.ondragstart=e=>e.dataTransfer.setData('application/json',JSON.stringify({fromDay:idx,taskIndex:ti})); el.textContent=t; slot.appendChild(el); });
  });
}
function allowDrop(e){ e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
function drop(e,toDay){ e.preventDefault(); e.currentTarget.classList.remove('drag-over'); try{ const {fromDay,taskIndex}=JSON.parse(e.dataTransfer.getData('application/json')); if(fromDay===toDay) return; const task=planSemanal[fromDay].tareas.splice(taskIndex,1)[0]; planSemanal[toDay].tareas.push(task); saveAll(); actualizarCalendarioSemanal(); actualizarTodoList(); showToast('✅ Plan actualizado'); }catch(err){console.warn(err);} }

/* Pesos table (simplified) */
function inicializarTablaPesos(){
  const microcicloFiltro=q('#filtro-microciclo').value || 'all';
  const filtroDia=q('#filtro-dia'); filtroDia.innerHTML = '<option value="all">Todos</option>' + Object.keys(mesociclo).filter(k=>k!=='Cardio').map(k=>`<option value="${k}">${k}</option>`).join('');
  const diaFiltro=filtroDia.value;
  const tbody=q('#tabla-pesos tbody'); tbody.innerHTML='';
  
  Object.keys(mesociclo).filter(k=>k!=='Cardio' && (diaFiltro==='all' || k===diaFiltro)).forEach(dia=>{
    mesociclo[dia].forEach(ej=>{
      const mcArray = ej.microciclo || [1,2,3,4,5,'Descarga'];
      mcArray.filter(m => microcicloFiltro==='all' || String(m)===String(microcicloFiltro)).forEach(mVal=>{
        const existing = pesos.find(p=>p.dia===dia && p.ejercicio===ej.ejercicio && String(p.microciclo)===String(mVal));
        const pesoVal = existing?.peso || 0;
        const reps = existing?.reps || '';
        
        const row = tbody.insertRow();
        row.innerHTML = `
          <td class="p-2 border text-sm">${ej.ejercicio}</td>
          <td class="p-2 border"><input type="number" class="w-20 p-1 border rounded focus:ring-2 focus:ring-blue-500" value="${pesoVal}" onchange="guardarPesoRepsSimple(this,'${dia}','${ej.ejercicio}',${JSON.stringify(mVal)})"></td>
          <td class="p-2 border"><input type="number" class="w-20 p-1 border rounded focus:ring-2 focus:ring-blue-500" value="${reps}" onchange="guardarPesoRepsSimple(this,'${dia}','${ej.ejercicio}',${JSON.stringify(mVal)})"></td>
          <td class="p-2 border text-sm ${reps>0? 'bg-green-500 text-white':'bg-gray-100'}">${reps>0? '✅ Completado':'⏳ Pendiente'}</td>
        `;
      });
    });
  });
}

/* Simplified peso/reps saving */
window.guardarPesoRepsSimple = function(input, dia, ejercicio, microciclo) {
  const row = input.closest('tr');
  const peso = parseFloat(row.cells[1].querySelector('input').value) || 0;
  const reps = parseInt(row.cells[2].querySelector('input').value) || 0;
  
  if (peso <= 0 && reps <= 0) {
    pesos = pesos.filter(p => !(p.dia === dia && p.ejercicio === ejercicio && String(p.microciclo) === String(microciclo)));
  } else {
    pesos = pesos.filter(p => !(p.dia === dia && p.ejercicio === ejercicio && String(p.microciclo) === String(microciclo)));
    pesos.push({ dia, ejercicio, microciclo, peso, reps, fecha: todayISO() });
  }
  
  saveAll();
  row.cells[3].className = `p-2 border text-sm ${reps > 0 ? 'bg-green-500 text-white' : 'bg-gray-100'}`;
  row.cells[3].textContent = reps > 0 ? '✅ Completado' : '⏳ Pendiente';
  
  if (reps > 0) {
    showToast(`✅ ${ejercicio} guardado`);
    actualizarAdherenciaTask('pesos', true);
  }
};

/* Cardio table (simplified) */
function inicializarTablaCardio(){
  const filtro = q('#filtro-microciclo-cardio').value || 'all'; 
  const tbody=q('#tabla-cardio tbody'); tbody.innerHTML='';
  
  mesociclo.Cardio.filter(c=> filtro==='all' || String(c.microciclo)===String(filtro)).forEach(c=>{
    c.sesiones.forEach(s=>{
      const existing = cardio.find(r=>String(r.microciclo)===String(c.microciclo) && r.sesionId===s.id && r.fecha===todayISO());
      const row = tbody.insertRow();
      row.innerHTML = `
        <td class="p-2 border text-sm">${existing?.fecha||todayISO()}</td>
        <td class="p-2 border text-sm">Sesión ${s.id}</td>
        <td class="p-2 border"><input type="number" class="w-20 p-1 border rounded focus:ring-2 focus:ring-blue-500" value="${existing?.km||''}" onchange="guardarCardioSimple(this,${c.microciclo},${s.id})"></td>
        <td class="p-2 border"><input type="number" class="w-20 p-1 border rounded focus:ring-2 focus:ring-blue-500" value="${existing?.tiempo||''}" onchange="guardarCardioSimple(this,${c.microciclo},${s.id})"></td>
        <td class="p-2 border text-sm ${existing && existing.km>=s.km ? 'bg-green-500 text-white':'bg-gray-100'}">${existing && existing.km>=s.km ? '✅ Completado':'⏳ Pendiente'}</td>
      `;
    });
  });
}

window.guardarCardioSimple = function(input, microciclo, sesionId) {
  const row = input.closest('tr');
  const km = parseFloat(row.cells[2].querySelector('input').value) || 0;
  const tiempo = parseInt(row.cells[3].querySelector('input').value) || 0;
  
  if (km <= 0 || tiempo <= 0) {
    showToast('⚠️ KM y tiempo deben ser > 0', 'error');
    return;
  }
  
  const fecha = todayISO();
  cardio = cardio.filter(c => !(String(c.microciclo) === String(microciclo) && c.sesionId === sesionId && c.fecha === fecha));
  cardio.push({
    fecha, microciclo, sesionId, km, tiempo,
    ritmo: tiempo/km,
    calorias: Math.round(tiempo * (tiempo/km > 6 ? 10 : 12))
  });
  
  saveAll();
  row.cells[4].className = 'p-2 border text-sm bg-green-500 text-white';
  row.cells[4].textContent = '✅ Completado';
  showToast(`✅ Cardio guardado: ${km}km en ${tiempo}min`);
  actualizarAdherenciaTask('cardio', true);
  inicializarTablaCardio();
};

/* Dieta simple */
q('#btn-guardar-dieta').addEventListener('click', ()=>{
  const f=q('#fecha-dieta').value||todayISO(), 
      c=parseInt(q('#calorias-dieta').value)||0, 
      p=parseInt(q('#proteinas-dieta').value)||0, 
      carb=parseInt(q('#carbos-dieta').value)||0, 
      g=parseInt(q('#grasas-dieta').value)||0, 
      ay=!!q('#ayuno-dieta').checked; 
  
  if(c<=0||p<=0||carb<=0||g<=0){
    showToast('⚠️ Introduce valores válidos', 'error');
    return;
  } 
  
  dieta=dieta.filter(d=>d.fecha!==f); 
  dieta.push({fecha:f,calorias:c,proteinas:p,carbos:carb,grasas:g,ayuno:ay}); 
  saveAll(); 
  actualizarAdherenciaTask('dieta', c>=1700 && c<=1900 && p>=150 && p<=185); 
  inicializarTablaDieta();
  showToast('✅ Dieta guardada');
});

function inicializarTablaDieta(){ 
  const tbody=q('#tabla-dieta tbody'); tbody.innerHTML=''; 
  dieta.forEach(reg=>{ 
    const estadoClass = reg.calorias>=1700 && reg.calorias<=1900 && reg.proteinas>=150 && reg.proteinas<=185 ? 'bg-green-500 text-white' : 'bg-yellow-500'; 
    const fb=[]; 
    if(reg.calorias>=1700 && reg.calorias<=1900) fb.push('✅ Calorías en rango'); 
    else if(reg.calorias<1700) fb.push('⚠️ Calorías bajas'); 
    else fb.push('⚠️ Calorías altas'); 
    if(reg.proteinas>=150 && reg.proteinas<=185) fb.push('✅ Proteínas ok'); 
    else fb.push('⚠️ Ajustar proteínas'); 
    const tr=tbody.insertRow(); 
    tr.innerHTML=`
      <td class="p-2 border text-sm">${reg.fecha}</td>
      <td class="p-2 border">${reg.calorias}</td>
      <td class="p-2 border">${reg.proteinas}</td>
      <td class="p-2 border ${estadoClass}">${reg.calorias>=1700 && reg.calorias<=1900 && reg.proteinas>=150 && reg.proteinas<=185 ? '✅' : '⚠️'}</td>
      <td class="p-2 border text-xs">${fb.map(f=>`<p>${f}</p>`).join('')}</td>
    `; 
  }); 
}

/* init */
document.addEventListener('DOMContentLoaded',()=>{
  // Quick entry functionality
  q('#quick-save').addEventListener('click', handleQuickSave);
  
  // attach filters
  q('#filtro-microciclo').addEventListener('change', inicializarTablaPesos);
  q('#filtro-dia').addEventListener('change', inicializarTablaPesos);
  q('#filtro-microciclo-cardio').addEventListener('change', inicializarTablaCardio);
  
  // setup real-time validation
  setupRealTimeValidation();
  
  // initial render
  actualizarProgresoGeneral(); 
  actualizarTodoList(); 
  crearGraficoPeso(); 
  crearGraficoAdherencia(); 
  actualizarCalendarioSemanal(); 
  inicializarTablaPesos(); 
  inicializarTablaCardio(); 
  inicializarTablaDieta();
  
  // periodic light refresh
  setInterval(()=>{ actualizarProgresoGeneral(); actualizarTodoList(); actualizarGraficoAdherencia(); },30000);
  
  // export
  q('#btn-export').addEventListener('click',()=>{ 
    const data={estado,pesos,cardio,dieta,planSemanal,adherenciaDiaria}; 
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); 
    const a=document.createElement('a'); 
    a.href=URL.createObjectURL(blob); 
    a.download='entrenamiento.json'; 
    a.click(); 
    URL.revokeObjectURL(a.href);
    showToast('✅ Datos exportados');
  });
  
  // Welcome message
  showToast('🎉 ¡Bienvenido a tu dashboard optimizado!');
});

/* cleanup visuals */
document.addEventListener('dragend',e=>{ if(e.target) e.target.style.opacity='1'; });
document.addEventListener('dragleave',e=>{ if(e.target) e.target.classList.remove('drag-over'); });
</script>
</body>
</html>