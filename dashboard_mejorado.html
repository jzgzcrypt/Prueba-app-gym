<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard de Entrenamiento â€” Optimizado</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
  body{ -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  .sidebar{transition:transform .28s ease;}
  @media (max-width:767px){ .sidebar-hidden{transform:translateX(-100%);} }
  .section{display:none;} .section.active{display:block;}
  .card{transition:transform .18s ease,box-shadow .18s ease}
  .card:hover{transform:translateY(-4px);box-shadow:0 10px 20px rgba(2,6,23,.06);}
  .drag-over{background-color:rgba(59,130,246,.06);border:2px dashed rgba(59,130,246,.18);}
  canvas{display:block;height:240px !important;max-height:360px;}
  
  /* Toast Notifications */
  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #10b981;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    z-index: 1000;
    animation: slideIn 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  .toast.error { background: #ef4444; }
  .toast.warning { background: #f59e0b; }
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  /* Loading States */
  .loading {
    opacity: 0.6;
    pointer-events: none;
  }
  .loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid #3b82f6;
    border-top: 2px solid transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Quick Entry Styles */
  .quick-entry {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    padding: 24px;
    color: white;
  }
  .quick-entry input, .quick-entry select {
    background: rgba(255,255,255,0.9);
    border: none;
    border-radius: 8px;
    padding: 12px;
    color: #1f2937;
  }
  .quick-entry input:focus, .quick-entry select:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
  }
  
  /* Success States */
  .success {
    background: #10b981 !important;
    color: white !important;
    border-color: #059669 !important;
  }
  
  /* Simplified Table */
  .simplified-table {
    font-size: 14px;
  }
  .simplified-table th {
    background: #f8fafc;
    font-weight: 600;
    color: #374151;
  }
</style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 font-sans text-gray-800">
<div class="flex min-h-screen">
  <aside id="sidebar" class="sidebar fixed top-0 left-0 w-64 bg-gradient-to-b from-gray-800 to-gray-900 text-white h-full p-6 z-30 md:translate-x-0 sidebar-hidden">
    <h3 class="text-xl font-bold mb-6 text-center">Mi Progreso</h3>
    <nav class="space-y-2 text-sm">
      <a href="#dashboard" data-section="dashboard" class="block py-2 px-3 rounded hover:bg-gray-700 transition-colors">ğŸ“Š Dashboard</a>
      <a href="#entreno-hoy" data-section="entreno-hoy" class="block py-2 px-3 rounded hover:bg-gray-700 transition-colors">ğŸ“ Entreno Hoy</a>
      <a href="#cardio-hoy" data-section="cardio-hoy" class="block py-2 px-3 rounded hover:bg-gray-700 transition-colors">ğŸƒâ€â™‚ï¸ Cardio Hoy</a>
      <a href="#registro-neat" data-section="registro-neat" class="block py-2 px-3 rounded hover:bg-gray-700 transition-colors">ğŸš¶ NEAT</a>
      <a href="#registro-pesos" data-section="registro-pesos" class="block py-2 px-3 rounded hover:bg-gray-700 transition-colors">ğŸ‹ï¸ Registro Pesos</a>
      <a href="#registro-cardio" data-section="registro-cardio" class="block py-2 px-3 rounded hover:bg-gray-700 transition-colors">ğŸƒ Registro Cardio</a>
      <a href="#pautas-dieta" data-section="pautas-dieta" class="block py-2 px-3 rounded hover:bg-gray-700 transition-colors">ğŸ¥— Pautas Dieta</a>
      <a href="#gestion-plan" data-section="gestion-plan" class="block py-2 px-3 rounded hover:bg-gray-700 transition-colors">ğŸ§­ GestiÃ³n Plan</a>
      <a href="#perfil" data-section="perfil" class="block py-2 px-3 rounded hover:bg-gray-700 transition-colors">ğŸ‘¤ Perfil</a>
    </nav>
  </aside>

  <main class="flex-1 ml-0 md:ml-64 p-6">
    <button id="btn-menu" class="md:hidden mb-4 p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">â˜° MenÃº</button>

    <section id="dashboard" class="section active">
      <h1 class="text-3xl font-bold text-center mb-6">Mi Dashboard</h1>
      
      <!-- QUICK ENTRY FORM - NUEVA FUNCIONALIDAD -->
      <div class="quick-entry mb-6">
        <h2 class="text-xl font-bold mb-4 text-center">Entrada RÃ¡pida de Hoy</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium mb-2">Peso (kg)</label>
            <input type="number" id="quick-weight" step="0.1" placeholder="85.0" class="w-full">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Cintura (cm)</label>
            <input type="number" id="quick-waist" step="0.1" placeholder="85" class="w-full">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Entrenamiento</label>
            <select id="quick-workout" class="w-full">
              <option value="">Seleccionar...</option>
              <option value="Pull">ğŸ‹ï¸ Pull</option>
              <option value="Push">ğŸ’ª Push</option>
              <option value="Piernas">ğŸ¦µ Piernas</option>
              <option value="Cardio">ğŸƒ Cardio</option>
              <option value="Descanso">ğŸ˜´ Descanso</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Cardio (km)</label>
            <input type="number" id="quick-cardio" step="0.1" placeholder="3.5" class="w-full">
          </div>
          <div class="flex items-end">
            <button id="quick-save" class="w-full bg-white text-purple-600 py-3 px-4 rounded-lg font-semibold hover:bg-gray-100 transition-colors">
              ğŸ’¾ Guardar Todo
            </button>
          </div>
        </div>
        <div id="quick-status" class="mt-3 text-center text-sm opacity-0 transition-opacity"></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="card bg-white p-6 rounded-xl shadow">
          <h2 class="text-lg font-semibold mb-4">Progreso General</h2>
          <div class="flex items-center justify-center">
            <div class="relative w-28 h-28">
              <svg viewBox="0 0 100 100" class="w-28 h-28 -rotate-90">
                <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"></circle>
                <circle id="progress-circle" cx="50" cy="50" r="40" stroke="#3b82f6" stroke-width="8" fill="none" stroke-linecap="round" stroke-dasharray="0 251"></circle>
              </svg>
              <div class="absolute inset-0 flex items-center justify-center">
                <span id="progress-percentage" class="text-xl font-bold text-blue-600">0%</span>
              </div>
            </div>
          </div>
          <p id="days-elapsed" class="text-center text-sm text-gray-600 mt-3">DÃ­a 1 de 42</p>
        </div>

        <div class="card bg-white p-6 rounded-xl shadow">
          <h2 class="text-lg font-semibold mb-4">Estado Actual</h2>
          <div class="space-y-3">
            <div class="flex justify-between"><span class="text-sm text-gray-600">Peso</span><span id="estado-peso-display" class="font-bold">85.0 kg</span></div>
            <div class="flex justify-between"><span class="text-sm text-gray-600">Cintura</span><span id="estado-cintura-display" class="font-bold">? cm</span></div>
            <div class="flex justify-between"><span class="text-sm text-gray-600">Grasa</span><span id="bodyfat-display" class="font-bold">? %</span></div>
            <div class="w-full bg-gray-200 rounded-full h-2 mt-3"><div id="peso-progress-bar" class="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full transition-all duration-500" style="width:0%"></div></div>
          </div>
        </div>

        <div class="card bg-white p-6 rounded-xl shadow">
          <h2 class="text-lg font-semibold mb-4">To-Do Hoy</h2>
          <div id="todo-list" class="space-y-3"></div>
          <div class="mt-3">
            <div class="flex justify-between"><span class="text-sm text-gray-600">Completado</span><span id="adherencia-porcentaje" class="font-bold text-green-600">0%</span></div>
            <div class="w-full bg-gray-200 rounded-full h-3 mt-2"><div id="adherencia-bar" class="bg-gradient-to-r from-green-500 to-green-600 h-3 rounded-full transition-all duration-500" style="width:0%"></div></div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="card bg-white p-6 rounded-xl shadow" style="min-height:240px">
          <h3 class="font-semibold mb-3">EvoluciÃ³n del Peso</h3>
          <canvas id="peso-chart" height="240"></canvas>
        </div>
        <div class="card bg-white p-6 rounded-xl shadow" style="min-height:240px">
          <h3 class="font-semibold mb-3">Adherencia Semanal</h3>
          <canvas id="adherencia-chart" height="240"></canvas>
        </div>
      </div>

      <div class="card bg-white p-6 rounded-xl shadow mb-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold">PlanificaciÃ³n Semanal</h3>
          <button id="reset-plan" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 transition-colors">ğŸ”„ Reset</button>
        </div>
        <div id="calendar-semanal" class="grid grid-cols-1 md:grid-cols-7 gap-3"></div>
        <p class="text-xs text-gray-500 mt-3">Arrastra actividades. Colores: ğŸ”µ Pull Â· ğŸŸ¢ Push Â· ğŸŸ¡ Piernas Â· ğŸ”´ Cardio Â· âšª Descanso</p>
      </div>
    </section>

    <!-- NUEVA SECCIÃ“N: Entreno de Hoy (ligera y enfocada a reps) -->
    <section id="entreno-hoy" class="section">
      <h1 class="text-2xl font-bold mb-4">ğŸ“ Entreno de Hoy</h1>
      <div class="bg-white p-4 rounded-xl shadow mb-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <div>
            <label class="text-sm font-medium">DÃ­a planificado</label>
            <input id="entreno-dia-hoy" class="mt-1 p-2 border rounded w-full" readonly />
          </div>
          <div>
            <label class="text-sm font-medium">Microciclo actual</label>
            <input id="entreno-microciclo" type="number" min="1" class="mt-1 p-2 border rounded w-full" />
          </div>
          <div class="md:col-span-2 flex items-end gap-2">
            <button id="btn-refrescar-entreno" class="px-3 py-2 bg-blue-600 text-white rounded">ğŸ”„ Refrescar</button>
            <button id="btn-aprender-entreno" class="px-3 py-2 bg-emerald-600 text-white rounded">ğŸ§  Ajustar recomendaciones</button>
          </div>
        </div>
      </div>
      <div class="bg-white p-4 rounded-xl shadow overflow-x-auto">
        <table class="min-w-full border simplified-table">
          <thead>
            <tr class="bg-blue-600 text-white text-sm"><th class="p-2">Ejercicio</th><th class="p-2">Peso reco.</th><th class="p-2">Rango reps</th><th class="p-2">Reps</th><th class="p-2">Peso usado</th><th class="p-2">Estado</th></tr>
          </thead>
          <tbody id="tbody-entreno-hoy"></tbody>
        </table>
      </div>
    </section>

    <!-- NUEVA SECCIÃ“N: Cardio de Hoy -->
    <section id="cardio-hoy" class="section">
      <h1 class="text-2xl font-bold mb-4">ğŸƒâ€â™‚ï¸ Cardio de Hoy</h1>
      <div class="bg-white p-4 rounded-xl shadow mb-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <div>
            <label class="text-sm font-medium">Microciclo actual</label>
            <input id="cardio-microciclo" type="number" min="1" class="mt-1 p-2 border rounded w-full" />
          </div>
          <div>
            <label class="text-sm font-medium">SesiÃ³n sugerida</label>
            <input id="cardio-sesion" class="mt-1 p-2 border rounded w-full" readonly />
          </div>
          <div class="md:col-span-2 flex items-end gap-2">
            <button id="btn-refrescar-cardio" class="px-3 py-2 bg-blue-600 text-white rounded">ğŸ”„ Refrescar</button>
            <button id="btn-aprender-cardio" class="px-3 py-2 bg-emerald-600 text-white rounded">ğŸ§  Ajustar recomendaciones</button>
          </div>
        </div>
      </div>
      <div class="bg-white p-4 rounded-xl shadow">
        <div id="cardio-plan-texto" class="text-sm text-gray-700 mb-3"></div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="text-sm font-medium">KM realizados</label>
            <input id="cardio-km-hoy" type="number" step="0.1" class="mt-1 p-2 border rounded w-full" />
          </div>
          <div>
            <label class="text-sm font-medium">Tiempo (min)</label>
            <input id="cardio-tiempo-hoy" type="number" class="mt-1 p-2 border rounded w-full" />
          </div>
          <div class="flex items-end">
            <button id="btn-guardar-cardio-hoy" class="px-4 py-2 bg-blue-600 text-white rounded w-full">ğŸ’¾ Guardar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- NUEVA SECCIÃ“N: NEAT -->
    <section id="registro-neat" class="section">
      <h1 class="text-2xl font-bold mb-4">ğŸš¶ NEAT (Actividad diaria)</h1>
      <div class="bg-white p-4 rounded-xl shadow mb-4">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
          <div>
            <label class="text-sm font-medium">Pasos</label>
            <input id="neat-steps" type="number" class="mt-1 p-2 border rounded w-full" />
          </div>
          <div>
            <label class="text-sm font-medium">Tiempo (min)</label>
            <input id="neat-min" type="number" class="mt-1 p-2 border rounded w-full" />
          </div>
          <div>
            <label class="text-sm font-medium">Velocidad (km/h)</label>
            <input id="neat-vel" type="number" step="0.1" class="mt-1 p-2 border rounded w-full" />
          </div>
          <div>
            <label class="text-sm font-medium">Distancia (km)</label>
            <input id="neat-km" type="number" step="0.1" class="mt-1 p-2 border rounded w-full" />
          </div>
          <div class="flex items-end">
            <button id="btn-guardar-neat" class="px-4 py-2 bg-blue-600 text-white rounded w-full">ğŸ’¾ Guardar NEAT</button>
          </div>
        </div>
      </div>
      <div class="bg-white p-4 rounded-xl shadow overflow-x-auto">
        <div class="mb-2 text-sm">CalorÃ­as NEAT hoy: <span id="neat-cal-hoy" class="font-semibold">0</span> kcal</div>
        <table class="min-w-full border simplified-table">
          <thead><tr class="bg-blue-600 text-white text-sm"><th class="p-2">Fecha</th><th class="p-2">Pasos</th><th class="p-2">Tiempo</th><th class="p-2">Velocidad</th><th class="p-2">Distancia</th><th class="p-2">Kcal</th></tr></thead>
          <tbody id="tabla-neat"></tbody>
        </table>
      </div>
    </section>

    <!-- NUEVA SECCIÃ“N: GestiÃ³n Plan -->
    <section id="gestion-plan" class="section">
      <h1 class="text-2xl font-bold mb-4">ğŸ§­ GestiÃ³n de Plan</h1>
      <div class="bg-white p-4 rounded-xl shadow mb-4">
        <p class="text-sm text-gray-600 mb-2">Pega aquÃ­ tu plan en texto (IA) con el formato "DÃ­a X: Tipo" y ejercicios por lÃ­neas:</p>
        <textarea id="plan-texto" rows="8" class="w-full p-2 border rounded" placeholder="DÃ­a 1: Pull\nBent over rows: Top 30kg 6-8; Resto 25kg 8-10 x2\n...\nDÃ­a 2: Push\n..."></textarea>
        <div class="flex gap-2 mt-3">
          <button id="btn-parse-plan" class="px-4 py-2 bg-blue-600 text-white rounded">ğŸ“¥ Importar desde texto</button>
          <label class="px-4 py-2 bg-gray-200 rounded cursor-pointer">ğŸ“‚ Cargar JSON<input id="input-json" type="file" accept="application/json" class="hidden"></label>
        </div>
        <div id="plan-feedback" class="text-sm mt-2"></div>
      </div>
    </section>

    <!-- NUEVA SECCIÃ“N: Perfil -->
    <section id="perfil" class="section">
      <h1 class="text-2xl font-bold mb-4">ğŸ‘¤ Perfil</h1>
      <div class="bg-white p-4 rounded-xl shadow">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
          <div>
            <label class="text-sm font-medium">Sexo</label>
            <select id="perfil-sexo" class="mt-1 p-2 border rounded w-full"><option value="M">Masculino</option><option value="F">Femenino</option></select>
          </div>
          <div>
            <label class="text-sm font-medium">Altura (cm)</label>
            <input id="perfil-altura" type="number" class="mt-1 p-2 border rounded w-full" />
          </div>
          <div>
            <label class="text-sm font-medium">Cuello (cm)</label>
            <input id="perfil-cuello" type="number" class="mt-1 p-2 border rounded w-full" />
          </div>
          <div>
            <label class="text-sm font-medium">Microciclo actual</label>
            <input id="perfil-microciclo" type="number" min="1" class="mt-1 p-2 border rounded w-full" />
          </div>
          <div class="flex items-end">
            <button id="btn-guardar-perfil" class="px-4 py-2 bg-blue-600 text-white rounded w-full">ğŸ’¾ Guardar Perfil</button>
          </div>
        </div>
      </div>
    </section>

    <section id="registro-pesos" class="section">
      <h1 class="text-2xl font-bold mb-4">Registro de Pesos</h1>
      
      <!-- Filtros Simplificados -->
      <div class="flex gap-4 mb-4">
        <div>
          <label class="text-sm font-medium">Microciclo</label>
          <select id="filtro-microciclo" class="mt-1 p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="all">Todos</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>Descarga</option>
          </select>
        </div>
        <div>
          <label class="text-sm font-medium">DÃ­a</label>
          <select id="filtro-dia" class="mt-1 p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="all">Todos</option>
          </select>
        </div>
        <div class="flex items-end">
          <button id="btn-simplified-view" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
            ğŸ“Š Vista Simplificada
          </button>
        </div>
      </div>
      
      <!-- Tabla Simplificada -->
      <div class="bg-white p-4 rounded shadow mb-6 overflow-x-auto">
        <table id="tabla-pesos" class="min-w-full border simplified-table">
          <thead>
            <tr class="bg-blue-600 text-white text-sm">
              <th class="p-2">Ejercicio</th>
              <th class="p-2">Peso</th>
              <th class="p-2">Reps</th>
              <th class="p-2">Estado</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="registro-cardio" class="section">
      <h1 class="text-2xl font-bold mb-4">Registro de Cardio</h1>
      <div class="mb-4">
        <label class="text-sm font-medium">Microciclo</label>
        <select id="filtro-microciclo-cardio" class="mt-1 p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <option value="all">Todos</option>
          <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>Descarga</option>
        </select>
      </div>
      <div class="bg-white p-4 rounded shadow mb-6 overflow-x-auto">
        <table id="tabla-cardio" class="min-w-full border simplified-table">
          <thead>
            <tr class="bg-blue-600 text-white text-sm">
              <th class="p-2">Fecha</th>
              <th class="p-2">SesiÃ³n</th>
              <th class="p-2">KM</th>
              <th class="p-2">Tiempo</th>
              <th class="p-2">Estado</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="pautas-dieta" class="section">
      <h1 class="text-2xl font-bold mb-4">Pautas de Dieta</h1>
      <div class="bg-white p-4 rounded shadow mb-6">
        <form id="form-dieta" class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <input type="date" id="fecha-dieta" value="2025-08-11" class="p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          <input type="number" id="calorias-dieta" placeholder="CalorÃ­as" class="p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          <input type="number" id="proteinas-dieta" placeholder="ProteÃ­nas (g)" class="p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          <input type="number" id="carbos-dieta" placeholder="Carbohidratos (g)" class="p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          <input type="number" id="grasas-dieta" placeholder="Grasas (g)" class="p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          <div class="flex items-center gap-2">
            <input type="checkbox" id="ayuno-dieta" class="rounded focus:ring-2 focus:ring-blue-500">
            <label>Ayuno 16/8</label>
          </div>
          <div class="md:col-span-3 flex gap-2">
            <button type="button" id="btn-guardar-dieta" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors">Guardar Dieta</button>
            <button type="button" id="btn-export" class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300 transition-colors">Export JSON</button>
          </div>
        </form>
      </div>
      <div class="bg-white p-4 rounded shadow overflow-x-auto">
        <table id="tabla-dieta" class="min-w-full border simplified-table">
          <thead>
            <tr class="bg-blue-600 text-white text-sm">
              <th class="p-2">Fecha</th>
              <th class="p-2">CalorÃ­as</th>
              <th class="p-2">ProteÃ­nas</th>
              <th class="p-2">Estado</th>
              <th class="p-2">Feedback</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<!-- Toast Container -->
<div id="toast-container"></div>

<script>
/* data (mesociclo completo kept) */
const mesociclo = {
  'DÃ­a 1: Pull': [
    { ejercicio: 'Bent over rows con mancuernas', sets: [{ tipo: 'Top', peso: 30, reps: '8-10' }, { tipo: 'Resto', peso: 25, reps: '10-12', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'JalÃ³n polea alta pecho apoyado unilateral', sets: [{ tipo: 'Normal', peso: 10, reps: '8-10', count: 3 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Remo polea pecho apoyado unilateral', sets: [{ tipo: 'Normal', peso: 10, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Face pull polea alta boca arriba', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Low cable rear delt row', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Curl alterno con mancuernas', sets: [{ tipo: 'Top', peso: 10, reps: '6-8' }, { tipo: 'Resto', peso: 10, reps: '10-12', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Curl bayesian en polea', sets: [{ tipo: 'Normal', peso: 10, reps: '10-12', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Crunch abdominal en polea alta', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] }
  ],
  'DÃ­a 2: Push': [
    { ejercicio: 'Press inclinado multipower 45Âº', sets: [{ tipo: 'Top', peso: 35, reps: '5-7' }, { tipo: 'Resto', peso: 30, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Contractora pectoral mÃ¡quina inclinada', sets: [{ tipo: 'Normal', peso: 10, reps: '10-12', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Press en mÃ¡quina', sets: [{ tipo: 'Normal', peso: 10, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Elevaciones laterales polea con muÃ±equera', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Elevaciones laterales mancuernas', sets: [{ tipo: 'Normal', peso: 10, reps: '>15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Press francÃ©s mancuernas', sets: [{ tipo: 'Top', peso: 10, reps: '8-10' }, { tipo: 'Resto', peso: 10, reps: '10-12', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'ExtensiÃ³n trÃ­ceps katana polea baja', sets: [{ tipo: 'Normal', peso: 10, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Crunch abdominal en polea alta', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] }
  ],
  'DÃ­a 3: Piernas': [
    { ejercicio: 'AducciÃ³n de cadera en mÃ¡quina', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Prensa 45Âº', sets: [{ tipo: 'Top', peso: 10, reps: '6-8' }, { tipo: 'Resto', peso: 10, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Sentadilla bÃºlgara (Ã©nfasis glÃºteo)', sets: [{ tipo: 'Top', peso: 20, reps: '6-8' }, { tipo: 'Resto', peso: 15, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Curl femoral en mÃ¡quina', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'ExtensiÃ³n de rodilla en mÃ¡quina', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Elevaciones de talones en mÃ¡quina', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] }
  ],
  'DÃ­a 4: Pull': [
    { ejercicio: 'Bent over rows con mancuernas', sets: [{ tipo: 'Top', peso: 30, reps: '6-8' }, { tipo: 'Resto', peso: 25, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'JalÃ³n polea alta pecho apoyado unilateral', sets: [{ tipo: 'Normal', peso: 10, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'MÃ¡quina remo espalda alta', sets: [{ tipo: 'Normal', peso: 10, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Pullover polea alta rodillas banco 60Âº', sets: [{ tipo: 'Normal', peso: 10, reps: '8-12', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Face pull polea alta boca arriba', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Low cable rear delt row', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Curl barra Z', sets: [{ tipo: 'Top', peso: 10, reps: '6-8' }, { tipo: 'Resto', peso: 10, reps: '10-12', count: 1 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Curl bayesian en polea', sets: [{ tipo: 'Normal', peso: 10, reps: '10-12', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Ab wheel', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] }
  ],
  'DÃ­a 5: Push': [
    { ejercicio: 'Press inclinado multipower 30Âº', sets: [{ tipo: 'Top', peso: 35, reps: '6-8' }, { tipo: 'Resto', peso: 30, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Contractora pectoral en mÃ¡quina', sets: [{ tipo: 'Normal', peso: 10, reps: '10-12', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Press militar mancuernas banco inclinado', sets: [{ tipo: 'Top', peso: 10, reps: '7-9' }, { tipo: 'Resto', peso: 10, reps: '9-11', count: 1 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Elevaciones laterales polea con muÃ±equera', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 3 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Elevaciones laterales mancuernas', sets: [{ tipo: 'Normal', peso: 10, reps: '>15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Press francÃ©s barra Z 30Âº', sets: [{ tipo: 'Top', peso: 10, reps: '8-10' }, { tipo: 'Resto', peso: 10, reps: '10-12', count: 1 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'ExtensiÃ³n trÃ­ceps katana polea baja', sets: [{ tipo: 'Normal', peso: 10, reps: '8-10', count: 3 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Crunch abdominal en polea alta', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] }
  ],
  'Cardio': [
    { microciclo: 1, sesiones: [
        { id: 1, plan: '25 min (15 min trote 6:30-7:00 min/km + 5 min intervalos [1 min 5:30 / 1 min caminando x3] + 5 min calentamiento/enfriamiento)', km: 3.5 },
        { id: 2, plan: '25 min (igual)', km: 3.5 },
        { id: 3, plan: '25 min (igual)', km: 3.5 }
    ]},
    { microciclo: 2, sesiones: [
        { id: 1, plan: '25 min (15 min trote 6:15-6:45)', km: 3.5 }, { id: 2, plan: '25 min', km: 3.5 }, { id: 3, plan: '25 min', km: 3.5 }
    ]},
    { microciclo: 3, sesiones: [
        { id: 1, plan: '25 min (intervalos 5:00)', km: 3.5 }, { id: 2, plan: '25 min', km: 3.5 }, { id: 3, plan: '25 min', km: 3.5 }
    ]},
    { microciclo: 4, sesiones: [
        { id: 1, plan: '27 min (15 min trote 6:00-6:30 + intervalos)', km: 4 }, { id: 2, plan: '27 min', km: 4 }, { id: 3, plan: '27 min', km: 4 }
    ]},
    { microciclo: 5, sesiones: [
        { id: 1, plan: '30 min (intervalos 4:45)', km: 4.5 }, { id: 2, plan: '30 min', km: 4.5 }, { id: 3, plan: '30 min', km: 4.5 }
    ]},
    { microciclo: 'Descarga', sesiones: [
        { id: 1, plan: '20 min trote ligero', km: 3 }, { id: 2, plan: '20 min', km: 3 }, { id: 3, plan: '20 min', km: 3 }
    ]}
  ]
};

/* minimal state helpers */
let estado = JSON.parse(localStorage.getItem('estado')) || [];
let pesos = JSON.parse(localStorage.getItem('pesos')) || [];
let cardio = JSON.parse(localStorage.getItem('cardio')) || [];
let dieta = JSON.parse(localStorage.getItem('dieta')) || [];
let planSemanal = JSON.parse(localStorage.getItem('planSemanal')) || [
  { dia: 'Lunes', tareas: ['DÃ­a 1: Pull', 'Cardio'] },
  { dia: 'Martes', tareas: ['DÃ­a 2: Push', 'Cardio'] },
  { dia: 'MiÃ©rcoles', tareas: ['DÃ­a 3: Piernas'] },
  { dia: 'Jueves', tareas: ['Descanso'] },
  { dia: 'Viernes', tareas: ['DÃ­a 4: Pull', 'Cardio'] },
  { dia: 'SÃ¡bado', tareas: ['DÃ­a 5: Push'] },
  { dia: 'Domingo', tareas: ['Descanso'] }
];
let adherenciaDiaria = JSON.parse(localStorage.getItem('adherenciaDiaria')) || {};

// Perfil y ajustes (persistidos)
let perfil = JSON.parse(localStorage.getItem('perfil')) || { sexo:'M', alturaCm:null, cuelloCm:null, microcicloActual:1 };
let ajustesEntreno = JSON.parse(localStorage.getItem('ajustesEntreno')) || {};
let ajustesCardio = JSON.parse(localStorage.getItem('ajustesCardio')) || {};
let neat = JSON.parse(localStorage.getItem('neat')) || [];
const q=(s,d=document)=>d.querySelector(s), qa=(s,d=document)=>Array.from(d.querySelectorAll(s));
const todayISO=()=>new Date().toISOString().split('T')[0];
const daysName=['Domingo','Lunes','Martes','MiÃ©rcoles','Jueves','Viernes','SÃ¡bado'];
const getTodayName=(d=new Date())=>daysName[d.getDay()];
const saveAll=()=>{ localStorage.setItem('estado',JSON.stringify(estado)); localStorage.setItem('pesos',JSON.stringify(pesos)); localStorage.setItem('cardio',JSON.stringify(cardio)); localStorage.setItem('dieta',JSON.stringify(dieta)); localStorage.setItem('planSemanal',JSON.stringify(planSemanal)); localStorage.setItem('adherenciaDiaria',JSON.stringify(adherenciaDiaria)); localStorage.setItem('perfil',JSON.stringify(perfil)); localStorage.setItem('ajustesEntreno',JSON.stringify(ajustesEntreno)); localStorage.setItem('ajustesCardio',JSON.stringify(ajustesCardio)); localStorage.setItem('neat',JSON.stringify(neat)); };

/* NUEVAS FUNCIONALIDADES - Toast Notifications */
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  
  const container = q('#toast-container');
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease forwards';
    setTimeout(() => container.removeChild(toast), 300);
  }, 3000);
}

/* NUEVAS FUNCIONALIDADES - Loading States */
function setLoading(element, isLoading) {
  if (isLoading) {
    element.classList.add('loading');
    element.style.position = 'relative';
  } else {
    element.classList.remove('loading');
  }
}

/* NUEVAS UTILIDADES - CÃ¡lculo % graso (US Navy aprox) */
function calcularPorcentajeGrasa(sexo, alturaCm, cuelloCm, cinturaCm, caderaCm){
  // Validaciones bÃ¡sicas
  if(!alturaCm || !cuelloCm || !cinturaCm) return null;
  const altura = parseFloat(alturaCm); const cuello = parseFloat(cuelloCm); const cintura = parseFloat(cinturaCm);
  if(!(altura>0) || !(cuello>0) || !(cintura>0) || cintura<=cuello) return null;
  const log10 = (x)=>Math.log(x)/Math.log(10);
  let bf;
  if(sexo==='F'){
    if(!caderaCm) return null; const cadera=parseFloat(caderaCm); if(!(cadera>0)) return null;
    bf = 495 / (1.29579 - 0.35004*log10(cintura + cadera - cuello) + 0.22100*log10(altura)) - 450;
  }else{
    bf = 495 / (1.0324 - 0.19077*log10(cintura - cuello) + 0.15456*log10(altura)) - 450;
  }
  return isFinite(bf)? Math.max(3, Math.min(60, bf)) : null;
}

/* NUEVAS FUNCIONALIDADES - Quick Entry */
function handleQuickSave(){
  const weight = parseFloat(q('#quick-weight').value);
  const waist = parseFloat(q('#quick-waist').value);
  const workout = q('#quick-workout').value;
  const cardioKm = parseFloat(q('#quick-cardio').value);
  
  // ValidaciÃ³n en tiempo real
  let hasData = false;
  let savedItems = [];
  
  if (weight && weight > 0) {
    guardarPesajeHoy(weight, isNaN(waist)? null : waist);
    savedItems.push('Peso');
    if(!isNaN(waist) && waist>0) savedItems.push('Cintura');
    hasData = true;
  }
  
  if (workout && workout !== 'Descanso') {
    actualizarAdherenciaTask('pesos', true);
    savedItems.push('Entrenamiento');
    hasData = true;
  }
  
  if (cardioKm && cardioKm > 0) {
    const fecha = todayISO();
    cardio = cardio.filter(c => c.fecha !== fecha);
    cardio.push({ fecha, microciclo: perfil.microcicloActual||1, sesionId: getSesionIdForToday(), km: cardioKm, tiempo: Math.round(cardioKm * 7), ritmo: Math.round(cardioKm * 7) / cardioKm, calorias: Math.round(cardioKm * 7 * 10) });
    actualizarAdherenciaTask('cardio', true);
    savedItems.push('Cardio');
    hasData = true;
  }
  
  if (hasData) {
    saveAll();
    showToast(`âœ… Guardado: ${savedItems.join(', ')}`);
    q('#quick-weight').value = '';
    q('#quick-waist').value = '';
    q('#quick-workout').value = '';
    q('#quick-cardio').value = '';
    actualizarProgresoGeneral();
    actualizarTodoList();
    actualizarGraficoPeso();
    actualizarGraficoAdherencia();
  } else {
    showToast('âš ï¸ Introduce al menos un dato', 'warning');
  }
}

/* NUEVAS FUNCIONALIDADES - ValidaciÃ³n en Tiempo Real */
function setupRealTimeValidation() {
  const inputs = qa('input[type="number"]');
  inputs.forEach(input => {
    input.addEventListener('input', (e) => {
      const value = parseFloat(e.target.value);
      const min = parseFloat(e.target.min) || 0;
      const max = parseFloat(e.target.max) || 999;
      
      if (value < min || value > max) {
        e.target.classList.add('border-red-500');
        e.target.classList.remove('border-green-500');
      } else {
        e.target.classList.remove('border-red-500');
        e.target.classList.add('border-green-500');
      }
    });
  });
}

/* UI wiring */
document.getElementById('btn-menu').addEventListener('click',()=>document.getElementById('sidebar').classList.toggle('sidebar-hidden'));
window.addEventListener('DOMContentLoaded',()=>{ if(window.innerWidth>=768) document.getElementById('sidebar').classList.remove('sidebar-hidden'); });

qa('a[data-section]').forEach(a=>a.addEventListener('click',e=>{
  e.preventDefault(); showSection(a.dataset.section);
  if(window.innerWidth<768) document.getElementById('sidebar').classList.add('sidebar-hidden');
}));
function showSection(id){
  qa('.section').forEach(s=>s.classList.remove('active')); q('#'+id).classList.add('active'); window.scrollTo({top:0,behavior:'smooth'});
  if(id==='registro-pesos') inicializarTablaPesos(); if(id==='registro-cardio') inicializarTablaCardio(); if(id==='pautas-dieta') inicializarTablaDieta(); if(id==='entreno-hoy') renderEntrenoHoy(); if(id==='cardio-hoy') renderCardioHoy(); if(id==='registro-neat') inicializarNeat(); if(id==='gestion-plan') inicializarGestionPlan(); if(id==='perfil') inicializarPerfil();
}

/* progress/adherence */
function actualizarProgresoGeneral(){
  const inicio=new Date('2025-08-11'); const diasTot=42;
  const diasTrans=Math.min(Math.floor((new Date()-inicio)/(1000*60*60*24))+1,diasTot);
  q('#days-elapsed').textContent=`DÃ­a ${diasTrans} de ${diasTot}`;
  const ultimo=estado.length?estado[estado.length-1]:{peso:85,cintura:null};
  const pIni=85,pObj=80;
  const pTemp=(diasTrans/diasTot)*100; const pPeso=Math.min(((pIni-ultimo.peso)/(pIni-pObj))*100,100);
  const pTotal=Math.max(pTemp*0.3 + pPeso*0.7,0);
  const circ=2*Math.PI*40; q('#progress-circle').style.strokeDasharray=`${(pTotal/100)*circ} ${circ}`;
  q('#progress-percentage').textContent=`${Math.round(pTotal)}%`; q('#estado-peso-display').textContent=`${ultimo.peso.toFixed(1)} kg`; q('#estado-cintura-display').textContent=ultimo.cintura?`${parseFloat(ultimo.cintura).toFixed(1)} cm`:'? cm';
  q('#peso-progress-bar').style.width=`${Math.max(0,pPeso)}%`;
  // Calcular y mostrar % graso si hay datos suficientes en perfil
  const bf = calcularPorcentajeGrasa(perfil.sexo||'M', perfil.alturaCm, perfil.cuelloCm, ultimo.cintura, perfil.caderaCm);
  q('#bodyfat-display').textContent = (bf!=null)? `${bf.toFixed(1)}%` : '? %';
}

/* todo list (includes pesaje diario) */
function actualizarTodoList(){
  const day = todayISO(); const planHoy=planSemanal.find(p=>p.dia===getTodayName())?.tareas||[];
  const container=q('#todo-list'); container.innerHTML='';
  const items=[];
  if(planHoy.some(t=>t.includes('Pull')||t.includes('Push')||t.includes('Piernas'))) items.push({id:'pesos',label:'Entreno de Pesos'});
  if(planHoy.includes('Cardio')) items.push({id:'cardio',label:'Cardio'});
  items.push({id:'neat',label:'NEAT (andar/movimiento)'});
  items.push({id:'dieta',label:'Dieta (~1800 kcal)'}); items.push({id:'ayuno',label:'Ayuno 16/8'});
  
  items.forEach(t=>{
    const div=document.createElement('div'); div.className='flex items-center justify-between';
    const checked = !!(adherenciaDiaria[day]&&adherenciaDiaria[day][t.id]);
    div.innerHTML = `<label class="flex items-center gap-2"><input type="checkbox" id="todo-${t.id}" ${checked?'checked':''}> <span class="text-sm">${t.label}</span></label>`;
    container.appendChild(div);
    q(`#todo-${t.id}`).addEventListener('change', e=>{ actualizarAdherenciaTask(t.id, e.target.checked); });
  });

  const total = container.querySelectorAll('input[type="checkbox"]').length;
  let done = 0; container.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ if(cb.checked) done++; });
  const pct = total? Math.round((done/total)*100) : 0;
  q('#adherencia-porcentaje').textContent = `${pct}%`; q('#adherencia-bar').style.width = `${pct}%`;
}

function actualizarAdherenciaTask(id,val){
  const d=todayISO(); if(!adherenciaDiaria[d]) adherenciaDiaria[d]={};
  adherenciaDiaria[d][id]=!!val; saveAll(); actualizarTodoList();
  showToast(val ? `âœ… ${id} completado` : `âŒ ${id} desmarcado`);
}

/* guardar pesaje diario (ahora acepta cintura opcional) */
function guardarPesajeHoy(value, cinturaVal=null){
  if(!value || isNaN(value) || value<=0){ showToast('âš ï¸ Ingresa un peso vÃ¡lido', 'error'); return; }
  const fecha=todayISO();
  // Si existe registro previo del dÃ­a, preserva cintura si no se provee
  const previo = estado.find(e=>e.fecha===fecha);
  const cintura = (cinturaVal!=null && cinturaVal!=='') ? parseFloat(cinturaVal) : (previo? previo.cintura : null);
  estado = estado.filter(e=>e.fecha!==fecha);
  estado.push({fecha, peso: parseFloat(value), cintura: cintura});
  estado.sort((a,b)=>new Date(a.fecha)-new Date(b.fecha));
  saveAll();
  showToast(`âœ… Peso guardado${cintura?` y cintura ${cintura} cm`:''}: ${parseFloat(value)} kg`);
  actualizarProgresoGeneral(); actualizarGraficoPeso(); actualizarTodoList();
}

/* Charts (destroy/create safe) */
let pesoChart=null, adherenciaChart=null;
function crearGraficoPeso(){
  if(pesoChart){ try{ pesoChart.destroy(); }catch(e){} pesoChart=null; }
  const ctx=q('#peso-chart').getContext('2d');
  pesoChart = new Chart(ctx,{ type:'line', data:{ labels:[], datasets:[{label:'Peso', data:[], borderColor:'#3b82f6', backgroundColor:'rgba(59,130,246,.08)', tension:.3, fill:true}]}, options:{responsive:true, maintainAspectRatio:false} });
  actualizarGraficoPeso();
}
function actualizarGraficoPeso(){
  if(!pesoChart) return crearGraficoPeso();
  const labels = estado.slice(-12).map(e=>new Date(e.fecha).toLocaleDateString());
  const data = estado.slice(-12).map(e=>e.peso);
  pesoChart.data.labels = labels.length?labels:['Inicio']; pesoChart.data.datasets[0].data = data.length?data:[85]; pesoChart.update();
}
function crearGraficoAdherencia(){ if(adherenciaChart){ try{ adherenciaChart.destroy(); }catch(e){} adherenciaChart=null; } const ctx=q('#adherencia-chart').getContext('2d');
  adherenciaChart = new Chart(ctx,{ type:'bar', data:{ labels:[], datasets:[{label:'Adherencia (%)', data:[], borderRadius:4, backgroundColor:[]} ]}, options:{responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true,max:100}}} });
  actualizarGraficoAdherencia();
}
function actualizarGraficoAdherencia(){
  if(!adherenciaChart) return crearGraficoAdherencia();
  const labels=[]; const data=[];
  for(let i=6;i>=0;i--){ const d=new Date(); d.setDate(d.getDate()-i); const iso=d.toISOString().split('T')[0]; labels.push(daysName[d.getDay()].slice(0,3)); const a=adherenciaDiaria[iso]||{}; const completed=(a.pesos?1:0)+(a.cardio?1:0)+(a.dieta?1:0)+(a.ayuno?1:0); data.push(Math.round((completed/4)*100)); }
  adherenciaChart.data.labels=labels; adherenciaChart.data.datasets[0].data=data; adherenciaChart.data.datasets[0].backgroundColor = data.map(d => d>=75? '#10b981': d>=50? '#f59e0b':'#ef4444'); adherenciaChart.update();
}

/* Calendar drag/drop */
function actualizarCalendarioSemanal(){
  const calendar=q('#calendar-semanal'); calendar.innerHTML='';
  planSemanal.forEach((day,idx)=>{ const isToday=day.dia===getTodayName(); const card=document.createElement('div'); card.className=`p-3 rounded-xl ${isToday?'bg-blue-50 border-blue-200':'bg-white border-gray-200'} card`;
    card.innerHTML=`<div class="font-semibold text-center mb-2">${day.dia}${isToday?'<div class="text-xs text-blue-600">HOY</div>':''}</div><div id="slot-${idx}" class="min-h-[80px] space-y-2" ondragover="allowDrop(event)" ondrop="drop(event,${idx})"></div>`; calendar.appendChild(card);
    const slot=q(`#slot-${idx}`);
    day.tareas.forEach((t,ti)=>{ const el=document.createElement('div'); el.className=`p-2 rounded text-xs font-medium ${t==='Descanso'?'bg-gray-200': t.includes('Pull')?'bg-blue-200': t.includes('Push')?'bg-green-200': t.includes('Piernas')?'bg-yellow-200':'bg-red-200'} draggable`; el.draggable=true; el.id=`task-${idx}-${ti}`; el.ondragstart=e=>e.dataTransfer.setData('application/json',JSON.stringify({fromDay:idx,taskIndex:ti})); el.textContent=t; slot.appendChild(el); });
  });
}
function allowDrop(e){ e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
function drop(e,toDay){ e.preventDefault(); e.currentTarget.classList.remove('drag-over'); try{ const {fromDay,taskIndex}=JSON.parse(e.dataTransfer.getData('application/json')); if(fromDay===toDay) return; const task=planSemanal[fromDay].tareas.splice(taskIndex,1)[0]; planSemanal[toDay].tareas.push(task); saveAll(); actualizarCalendarioSemanal(); actualizarTodoList(); showToast('âœ… Plan actualizado'); }catch(err){console.warn(err);} }

/* Pesos table (simplified) */
function inicializarTablaPesos(){
  const microcicloFiltro=q('#filtro-microciclo').value || 'all';
  const filtroDia=q('#filtro-dia'); filtroDia.innerHTML = '<option value="all">Todos</option>' + Object.keys(mesociclo).filter(k=>k!=='Cardio').map(k=>`<option value="${k}">${k}</option>`).join('');
  const diaFiltro=filtroDia.value;
  const tbody=q('#tabla-pesos tbody'); tbody.innerHTML='';
  
  Object.keys(mesociclo).filter(k=>k!=='Cardio' && (diaFiltro==='all' || k===diaFiltro)).forEach(dia=>{
    mesociclo[dia].forEach(ej=>{
      const mcArray = ej.microciclo || [1,2,3,4,5,'Descarga'];
      mcArray.filter(m => microcicloFiltro==='all' || String(m)===String(microcicloFiltro)).forEach(mVal=>{
        const existing = pesos.find(p=>p.dia===dia && p.ejercicio===ej.ejercicio && String(p.microciclo)===String(mVal));
        const pesoVal = existing?.peso || 0;
        const reps = existing?.reps || '';
        
        const row = tbody.insertRow();
        row.innerHTML = `
          <td class="p-2 border text-sm">${ej.ejercicio}</td>
          <td class="p-2 border"><input type="number" class="w-20 p-1 border rounded focus:ring-2 focus:ring-blue-500" value="${pesoVal}" onchange="guardarPesoRepsSimple(this,'${dia}','${ej.ejercicio}',${JSON.stringify(mVal)})"></td>
          <td class="p-2 border"><input type="number" class="w-20 p-1 border rounded focus:ring-2 focus:ring-blue-500" value="${reps}" onchange="guardarPesoRepsSimple(this,'${dia}','${ej.ejercicio}',${JSON.stringify(mVal)})"></td>
          <td class="p-2 border text-sm ${reps>0? 'bg-green-500 text-white':'bg-gray-100'}">${reps>0? 'âœ… Completado':'â³ Pendiente'}</td>
        `;
      });
    });
  });
}

/* Simplified peso/reps saving */
window.guardarPesoRepsSimple = function(input, dia, ejercicio, microciclo) {
  const row = input.closest('tr');
  const peso = parseFloat(row.cells[1].querySelector('input').value) || 0;
  const reps = parseInt(row.cells[2].querySelector('input').value) || 0;
  
  if (peso <= 0 && reps <= 0) {
    pesos = pesos.filter(p => !(p.dia === dia && p.ejercicio === ejercicio && String(p.microciclo) === String(microciclo)));
  } else {
    pesos = pesos.filter(p => !(p.dia === dia && p.ejercicio === ejercicio && String(p.microciclo) === String(microciclo)));
    pesos.push({ dia, ejercicio, microciclo, peso, reps, fecha: todayISO() });
  }
  
  saveAll();
  row.cells[3].className = `p-2 border text-sm ${reps > 0 ? 'bg-green-500 text-white' : 'bg-gray-100'}`;
  row.cells[3].textContent = reps > 0 ? 'âœ… Completado' : 'â³ Pendiente';
  
  if (reps > 0) {
    showToast(`âœ… ${ejercicio} guardado`);
    actualizarAdherenciaTask('pesos', true);
  }
};

/* Cardio table (simplified) */
function inicializarTablaCardio(){
  const filtro = q('#filtro-microciclo-cardio').value || 'all'; 
  const tbody=q('#tabla-cardio tbody'); tbody.innerHTML='';
  
  mesociclo.Cardio.filter(c=> filtro==='all' || String(c.microciclo)===String(filtro)).forEach(c=>{
    c.sesiones.forEach(s=>{
      const existing = cardio.find(r=>String(r.microciclo)===String(c.microciclo) && r.sesionId===s.id && r.fecha===todayISO());
      const row = tbody.insertRow();
      row.innerHTML = `
        <td class="p-2 border text-sm">${existing?.fecha||todayISO()}</td>
        <td class="p-2 border text-sm">SesiÃ³n ${s.id}</td>
        <td class="p-2 border"><input type="number" class="w-20 p-1 border rounded focus:ring-2 focus:ring-blue-500" value="${existing?.km||''}" onchange="guardarCardioSimple(this,${c.microciclo},${s.id})"></td>
        <td class="p-2 border"><input type="number" class="w-20 p-1 border rounded focus:ring-2 focus:ring-blue-500" value="${existing?.tiempo||''}" onchange="guardarCardioSimple(this,${c.microciclo},${s.id})"></td>
        <td class="p-2 border text-sm ${existing && existing.km>=s.km ? 'bg-green-500 text-white':'bg-gray-100'}">${existing && existing.km>=s.km ? 'âœ… Completado':'â³ Pendiente'}</td>
      `;
    });
  });
}

window.guardarCardioSimple = function(input, microciclo, sesionId) {
  const row = input.closest('tr');
  const km = parseFloat(row.cells[2].querySelector('input').value) || 0;
  const tiempo = parseInt(row.cells[3].querySelector('input').value) || 0;
  
  if (km <= 0 || tiempo <= 0) {
    showToast('âš ï¸ KM y tiempo deben ser > 0', 'error');
    return;
  }
  
  const fecha = todayISO();
  cardio = cardio.filter(c => !(String(c.microciclo) === String(microciclo) && c.sesionId === sesionId && c.fecha === fecha));
  cardio.push({
    fecha, microciclo, sesionId, km, tiempo,
    ritmo: tiempo/km,
    calorias: Math.round(tiempo * (tiempo/km > 6 ? 10 : 12))
  });
  
  saveAll();
  row.cells[4].className = 'p-2 border text-sm bg-green-500 text-white';
  row.cells[4].textContent = 'âœ… Completado';
  showToast(`âœ… Cardio guardado: ${km} km en ${tiempo} min`);
  actualizarAdherenciaTask('cardio', true);
  inicializarTablaCardio();
};

/* Dieta simple */
q('#btn-guardar-dieta').addEventListener('click', ()=>{
  const f=q('#fecha-dieta').value||todayISO(), 
      c=parseInt(q('#calorias-dieta').value)||0, 
      p=parseInt(q('#proteinas-dieta').value)||0, 
      carb=parseInt(q('#carbos-dieta').value)||0, 
      g=parseInt(q('#grasas-dieta').value)||0, 
      ay=!!q('#ayuno-dieta').checked; 
  
  if(c<=0||p<=0||carb<=0||g<=0){
    showToast('âš ï¸ Introduce valores vÃ¡lidos', 'error');
    return;
  } 
  
  dieta=dieta.filter(d=>d.fecha!==f); 
  dieta.push({fecha:f,calorias:c,proteinas:p,carbos:carb,grasas:g,ayuno:ay}); 
  saveAll(); 
  actualizarAdherenciaTask('dieta', c>=1700 && c<=1900 && p>=150 && p<=185); 
  inicializarTablaDieta();
  showToast('âœ… Dieta guardada');
});

function inicializarTablaDieta(){ 
  const tbody=q('#tabla-dieta tbody'); tbody.innerHTML=''; 
  dieta.forEach(reg=>{ 
    const estadoClass = reg.calorias>=1700 && reg.calorias<=1900 && reg.proteinas>=150 && reg.proteinas<=185 ? 'bg-green-500 text-white' : 'bg-yellow-500'; 
    const fb=[]; 
    if(reg.calorias>=1700 && reg.calorias<=1900) fb.push('âœ… CalorÃ­as en rango'); 
    else if(reg.calorias<1700) fb.push('âš ï¸ CalorÃ­as bajas'); 
    else fb.push('âš ï¸ CalorÃ­as altas'); 
    if(reg.proteinas>=150 && reg.proteinas<=185) fb.push('âœ… ProteÃ­nas ok'); 
    else fb.push('âš ï¸ Ajustar proteÃ­nas'); 
    const tr=tbody.insertRow(); 
    tr.innerHTML=`
      <td class="p-2 border text-sm">${reg.fecha}</td>
      <td class="p-2 border">${reg.calorias}</td>
      <td class="p-2 border">${reg.proteinas}</td>
      <td class="p-2 border ${estadoClass}">${reg.calorias>=1700 && reg.calorias<=1900 && reg.proteinas>=150 && reg.proteinas<=185 ? 'âœ…' : 'âš ï¸'}</td>
      <td class="p-2 border text-xs">${fb.map(f=>`<p>${f}</p>`).join('')}</td>
    `; 
  }); 
}

/* NUEVO: Entreno de Hoy (UI y guardado ligero) */
function renderEntrenoHoy(){
  const hoy = getTodayName();
  const hoyPlan = planSemanal.find(p=>p.dia===hoy)?.tareas?.find(t=>t.startsWith('DÃ­a')) || null;
  q('#entreno-dia-hoy').value = hoyPlan || 'Descanso';
  q('#entreno-microciclo').value = perfil.microcicloActual || 1;
  const tbody=q('#tbody-entreno-hoy'); tbody.innerHTML='';
  if(!hoyPlan || !mesociclo[hoyPlan]){ tbody.innerHTML = '<tr><td class="p-2 border text-sm" colspan="6">No hay entreno planificado hoy.</td></tr>'; return; }
  const ejercicios = mesociclo[hoyPlan];
  ejercicios.forEach((ej, idx)=>{
    const setTop = ej.sets && ej.sets[0] ? ej.sets[0] : {peso:0,reps:'8-10'};
    const key = `${hoyPlan}|${ej.ejercicio}|${perfil.microcicloActual}`;
    const recoPeso = (ajustesEntreno[key] && ajustesEntreno[key].pesoReco) ? ajustesEntreno[key].pesoReco : setTop.peso;
    const rango = setTop.reps || '8-10';
    const prev = pesos.find(p=>p.dia===hoyPlan && p.ejercicio===ej.ejercicio && String(p.microciclo)===String(perfil.microcicloActual));
    const repsPrev = prev?.reps || '';
    const pesoPrev = prev?.peso || recoPeso;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="p-2 border text-sm">${ej.ejercicio}</td>
      <td class="p-2 border text-sm">${recoPeso}</td>
      <td class="p-2 border text-sm">${rango}</td>
      <td class="p-2 border"><input type="number" class="w-20 p-1 border rounded" value="${repsPrev}" data-dia="${hoyPlan}" data-ej="${ej.ejercicio}" data-mc="${perfil.microcicloActual}" onchange="guardarEntrenoHoyInput(this)"></td>
      <td class="p-2 border"><input type="number" class="w-20 p-1 border rounded" value="${pesoPrev}" data-dia="${hoyPlan}" data-ej="${ej.ejercicio}" data-mc="${perfil.microcicloActual}" onchange="guardarEntrenoHoyInput(this)"></td>
      <td class="p-2 border text-sm">${(prev && prev.reps>0)?'âœ… Completado':'â³ Pendiente'}</td>`;
    tbody.appendChild(tr);
  });
}

// Guardar entrada de Entreno Hoy (detecta si cambiÃ³ reps o peso)
window.guardarEntrenoHoyInput = function(input){
  const tr = input.closest('tr');
  const dia = input.dataset.dia; const ejercicio = input.dataset.ej; const microciclo = parseInt(input.dataset.mc);
  const reps = parseInt(tr.cells[3].querySelector('input').value)||0; const peso = parseFloat(tr.cells[4].querySelector('input').value)||0;
  pesos = pesos.filter(p => !(p.dia===dia && p.ejercicio===ejercicio && String(p.microciclo)===String(microciclo)));
  if(peso>0 || reps>0){ pesos.push({dia, ejercicio, microciclo, peso, reps, fecha: todayISO()}); }
  saveAll();
  if(reps>0){ actualizarAdherenciaTask('pesos', true); showToast(`âœ… ${ejercicio} guardado`); }
}

// Algoritmo sencillo de ajuste de peso recomendado segÃºn reps logradas
function aprenderAjustesEntreno(){
  const hoyPlan = q('#entreno-dia-hoy').value; if(!mesociclo[hoyPlan]) return;
  (mesociclo[hoyPlan]||[]).forEach(ej=>{
    const key = `${hoyPlan}|${ej.ejercicio}|${perfil.microcicloActual}`;
    const setTop = ej.sets && ej.sets[0] ? ej.sets[0] : {peso:0,reps:'8-10'};
    const recoBase = (ajustesEntreno[key] && ajustesEntreno[key].pesoReco) ? ajustesEntreno[key].pesoReco : setTop.peso;
    const prev = pesos.find(p=>p.dia===hoyPlan && p.ejercicio===ej.ejercicio && String(p.microciclo)===String(perfil.microcicloActual));
    if(!prev) return;
    const rango = String(setTop.reps||'8-10');
    const [lo,hi] = rango.includes('-')? rango.split('-').map(n=>parseInt(n.trim())) : [parseInt(rango)||8, parseInt(rango)||10];
    let nuevo=recoBase;
    if(prev.reps>=hi+1) nuevo = Math.round(recoBase*1.025*10)/10; // +2.5%
    else if(prev.reps<=lo-1) nuevo = Math.max(1, Math.round(recoBase*0.975*10)/10); // -2.5%
    ajustesEntreno[key] = {pesoReco: nuevo};
  });
  saveAll();
  showToast('ğŸ§  Recomendaciones de peso ajustadas');
  renderEntrenoHoy();
}

/* Cardio de Hoy: sugiere sesiÃ³n en funciÃ³n del dÃ­a y guarda */
function getSesionIdForToday(){
  const d=getTodayName(); if(d==='Lunes'||d==='Martes') return 1; if(d==='MiÃ©rcoles'||d==='Jueves') return 2; if(d==='Viernes'||d==='SÃ¡bado') return 3; return 1;
}
function renderCardioHoy(){
  q('#cardio-microciclo').value = perfil.microcicloActual||1;
  const mc = parseInt(perfil.microcicloActual||1);
  const sesionId = getSesionIdForToday();
  q('#cardio-sesion').value = `SesiÃ³n ${sesionId}`;
  const cfg = (mesociclo.Cardio||[]).find(c=>String(c.microciclo)===String(mc));
  const ses = cfg? cfg.sesiones.find(s=>s.id===sesionId): null;
  const key = `${mc}|${sesionId}`;
  const recoKm = (ajustesCardio[key] && ajustesCardio[key].kmReco)? ajustesCardio[key].kmReco : (ses? ses.km : 3.0);
  q('#cardio-plan-texto').textContent = ses? (ses.plan || `Correr ${recoKm} km`) : 'No hay plan cardio definido para este microciclo';
  q('#cardio-km-hoy').value = '';
  q('#cardio-tiempo-hoy').value = '';
}
function guardarCardioHoy(){
  const mc=parseInt(q('#cardio-microciclo').value)||1; const sesionId=getSesionIdForToday();
  const km=parseFloat(q('#cardio-km-hoy').value)||0; const tiempo=parseInt(q('#cardio-tiempo-hoy').value)||0;
  if(km<=0 || tiempo<=0){ showToast('âš ï¸ KM y tiempo deben ser > 0', 'error'); return; }
  const fecha=todayISO();
  cardio = cardio.filter(c=> !(String(c.microciclo)===String(mc) && c.sesionId===sesionId && c.fecha===fecha));
  cardio.push({fecha, microciclo:mc, sesionId, km, tiempo, ritmo: tiempo/km, calorias: Math.round(tiempo * (tiempo/km > 6 ? 10 : 12))});
  saveAll();
  actualizarAdherenciaTask('cardio', true);
  showToast(`âœ… Cardio guardado: ${km} km en ${tiempo} min`);
}
function aprenderAjustesCardio(){
  const mc = parseInt(perfil.microcicloActual||1); const sesionId=getSesionIdForToday();
  const key = `${mc}|${sesionId}`;
  const hoy = todayISO(); const reg = cardio.find(c=>c.fecha===hoy && String(c.microciclo)===String(mc) && c.sesionId===sesionId);
  if(!reg){ showToast('â„¹ï¸ Registra el cardio de hoy para ajustar', 'warning'); return; }
  const cfg = (mesociclo.Cardio||[]).find(c=>String(c.microciclo)===String(mc));
  const ses = cfg? cfg.sesiones.find(s=>s.id===sesionId): null; const baseKm = ses? ses.km : reg.km;
  // Ajuste simple: si el ritmo fue <= 6 min/km y completÃ³ km base, sube +0.2 km; si >7, baja -0.2 km
  let nuevo = baseKm;
  if(reg.ritmo<=6) nuevo = Math.round((baseKm+0.2)*10)/10; else if(reg.ritmo>7) nuevo = Math.max(1, Math.round((baseKm-0.2)*10)/10);
  ajustesCardio[key] = {kmReco: nuevo};
  saveAll();
  showToast('ğŸ§  Recomendaciones de cardio ajustadas');
  renderCardioHoy();
}

/* NEAT: logging y calorÃ­as estimadas */
function estimateMetForWalking(speed){ if(!speed||speed<=0) return 3.0; if(speed<3) return 2.0; if(speed<4) return 2.8; if(speed<5) return 3.3; if(speed<6) return 3.8; if(speed<7) return 4.3; return 5.0; }
function calcularKcalNeat({steps, minutes, speed, km}){
  const w = (estado.length? estado[estado.length-1].peso : 80) || 80; // kg
  let kcal=0;
  if(steps && steps>0){ const perStep = w*0.0005; kcal += steps*perStep; }
  if(minutes && minutes>0){ const v = (speed && speed>0) ? speed : (km && km>0 ? (km/(minutes/60)) : null); const MET = estimateMetForWalking(v); kcal += MET * w * (minutes/60); }
  return Math.round(kcal);
}
function inicializarNeat(){
  const tbody=q('#tabla-neat'); tbody.innerHTML='';
  const hoy=todayISO(); let hoyKcal=0;
  neat.filter(n=>!!n).forEach(n=>{ const tr=tbody.insertRow(); tr.innerHTML=`<td class="p-2 border text-sm">${n.fecha}</td><td class="p-2 border text-sm">${n.steps||''}</td><td class="p-2 border text-sm">${n.minutes||''}</td><td class="p-2 border text-sm">${n.speed||''}</td><td class="p-2 border text-sm">${n.km||''}</td><td class="p-2 border text-sm">${n.kcal||0}</td>`; if(n.fecha===hoy) hoyKcal+=n.kcal||0; });
  q('#neat-cal-hoy').textContent = hoyKcal;
}
function guardarNeat(){
  const steps=parseInt(q('#neat-steps').value)||0; const minutes=parseInt(q('#neat-min').value)||0; const speed=parseFloat(q('#neat-vel').value)||0; const km=parseFloat(q('#neat-km').value)||0; const fecha=todayISO();
  if(steps<=0 && minutes<=0 && km<=0){ showToast('âš ï¸ Introduce al menos un dato de NEAT', 'error'); return; }
  const kcal = calcularKcalNeat({steps, minutes, speed, km});
  neat = neat.filter(n=>!(n.fecha===fecha && n.steps===steps && n.minutes===minutes && n.km===km));
  neat.push({fecha, steps: steps||null, minutes: minutes||null, speed: speed||null, km: km||null, kcal});
  saveAll();
  actualizarAdherenciaTask('neat', true);
  showToast(`âœ… NEAT guardado: ${kcal} kcal`);
  inicializarNeat();
}

/* GestiÃ³n del plan: parse desde texto + import JSON */
function inicializarGestionPlan(){ q('#plan-feedback').textContent=''; }
function parsePlanTexto(texto){
  // Parser simple basado en lÃ­neas. Formato esperado:
  // DÃ­a X: Tipo\nEjercicio: Top 30kg 6-8; Resto 25kg 8-10 x2
  const res = {};
  let diaActual=null;
  texto.split(/\n+/).map(l=>l.trim()).forEach(line=>{
    if(!line) return;
    const dMatch = line.match(/^D[iÃ­]a\s*\d+\s*:\s*(.+)$/i);
    if(dMatch){ diaActual = line.replace(/\s+/g,' ').trim(); res[diaActual] = []; return; }
    if(!diaActual) return;
    const [ejercicioPart, setsPart] = line.split(/:\s*/);
    if(!ejercicioPart) return;
    const ejercicio = ejercicioPart.trim();
    const sets=[];
    if(setsPart){
      setsPart.split(/;\s*/).forEach(s=>{
        const tipo = /top/i.test(s)?'Top':'Normal';
        const pesoMatch = s.match(/(\d+(?:\.\d+)?)\s*kg/i); const repsMatch = s.match(/(\d+\s*-\s*\d+|>\s*\d+)/i); const countMatch = s.match(/x\s*(\d+)/i);
        sets.push({ tipo, peso: pesoMatch? parseFloat(pesoMatch[1]): 0, reps: repsMatch? repsMatch[1].replace(/\s+/g,'') : '8-10', count: countMatch? parseInt(countMatch[1]): (tipo==='Top'?1:2) });
      });
    }
    res[diaActual].push({ ejercicio, sets, microciclo:[perfil.microcicloActual||1,'Descarga'] });
  });
  return res;
}

/* init */
document.addEventListener('DOMContentLoaded',()=>{
  // Quick entry functionality
  q('#quick-save').addEventListener('click', handleQuickSave);
  
  // Entreno hoy
  q('#btn-refrescar-entreno').addEventListener('click', ()=>{ perfil.microcicloActual=parseInt(q('#entreno-microciclo').value)||perfil.microcicloActual; saveAll(); renderEntrenoHoy(); });
  q('#btn-aprender-entreno').addEventListener('click', aprenderAjustesEntreno);
  
  // Cardio hoy
  q('#btn-refrescar-cardio').addEventListener('click', ()=>{ perfil.microcicloActual=parseInt(q('#cardio-microciclo').value)||perfil.microcicloActual; saveAll(); renderCardioHoy(); });
  q('#btn-aprender-cardio').addEventListener('click', aprenderAjustesCardio);
  q('#btn-guardar-cardio-hoy').addEventListener('click', guardarCardioHoy);
  
  // NEAT
  q('#btn-guardar-neat').addEventListener('click', guardarNeat);
  
  // Perfil
  q('#btn-guardar-perfil').addEventListener('click', guardarPerfil);
  
  // GestiÃ³n plan
  q('#btn-parse-plan').addEventListener('click', ()=>{
    try{
      const parsed = parsePlanTexto(q('#plan-texto').value||'');
      if(Object.keys(parsed).length===0){ q('#plan-feedback').textContent='âš ï¸ No se encontraron dÃ­as.'; q('#plan-feedback').className='text-sm text-yellow-600'; return; }
      // Mezcla con mesociclo actual
      Object.keys(parsed).forEach(k=>{ if(!mesociclo[k]) mesociclo[k]=parsed[k]; else mesociclo[k]=parsed[k]; });
      saveAll();
      q('#plan-feedback').textContent='âœ… Plan importado'; q('#plan-feedback').className='text-sm text-green-600';
      inicializarTablaPesos(); renderEntrenoHoy();
    }catch(err){ console.warn(err); q('#plan-feedback').textContent='âŒ Error al parsear'; q('#plan-feedback').className='text-sm text-red-600'; }
  });
  q('#input-json').addEventListener('change', (e)=>{
    const file=e.target.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=()=>{ try{ const data=JSON.parse(reader.result); if(data.estado) estado=data.estado; if(data.pesos) pesos=data.pesos; if(data.cardio) cardio=data.cardio; if(data.dieta) dieta=data.dieta; if(data.planSemanal) planSemanal=data.planSemanal; if(data.adherenciaDiaria) adherenciaDiaria=data.adherenciaDiaria; if(data.perfil) perfil=data.perfil; if(data.ajustesEntreno) ajustesEntreno=data.ajustesEntreno; if(data.ajustesCardio) ajustesCardio=data.ajustesCardio; if(data.neat) neat=data.neat; saveAll(); showToast('âœ… Datos importados'); actualizarProgresoGeneral(); actualizarCalendarioSemanal(); inicializarTablaPesos(); inicializarTablaCardio(); inicializarTablaDieta(); renderEntrenoHoy(); renderCardioHoy(); inicializarNeat(); }catch(err){ console.warn(err); showToast('âŒ Error al importar', 'error'); } }; reader.readAsText(file);
  });
  
  // attach filters
  q('#filtro-microciclo').addEventListener('change', inicializarTablaPesos);
  q('#filtro-dia').addEventListener('change', inicializarTablaPesos);
  q('#filtro-microciclo-cardio').addEventListener('change', inicializarTablaCardio);
  
  // setup real-time validation
  setupRealTimeValidation();
  
  // initial render
  actualizarProgresoGeneral(); 
  actualizarTodoList(); 
  crearGraficoPeso(); 
  crearGraficoAdherencia(); 
  actualizarCalendarioSemanal(); 
  inicializarTablaPesos(); 
  inicializarTablaCardio(); 
  inicializarTablaDieta();
  renderEntrenoHoy();
  renderCardioHoy();
  inicializarNeat();
  inicializarPerfil();
  
  // periodic light refresh
  setInterval(()=>{ actualizarProgresoGeneral(); actualizarTodoList(); actualizarGraficoAdherencia(); },30000);
  
  // export
  q('#btn-export').addEventListener('click',()=>{ 
    const data={estado,pesos,cardio,dieta,planSemanal,adherenciaDiaria,perfil,ajustesEntreno,ajustesCardio,neat}; 
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); 
    const a=document.createElement('a'); 
    a.href=URL.createObjectURL(blob); 
    a.download='entrenamiento.json'; 
    a.click(); 
    URL.revokeObjectURL(a.href);
    showToast('âœ… Datos exportados');
  });
  
  // Welcome message
  showToast('ğŸ‰ Â¡Bienvenido a tu dashboard optimizado!');
});

/* cleanup visuals */
document.addEventListener('dragend',e=>{ if(e.target) e.target.style.opacity='1'; });
document.addEventListener('dragleave',e=>{ if(e.target) e.target.classList.remove('drag-over'); });
</script>
</body>
</html>