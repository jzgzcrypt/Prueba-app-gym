<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard de Entrenamiento ‚Äî Definitivo</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
  body{ -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  .sidebar{transition:transform .28s ease;}
  @media (max-width:767px){ .sidebar-hidden{transform:translateX(-100%);} }
  .section{display:none;} .section.active{display:block;}
  .card{transition:transform .18s ease,box-shadow .18s ease}
  .card:hover{transform:translateY(-4px);box-shadow:0 10px 20px rgba(2,6,23,.06);}
  .drag-over{background-color:rgba(59,130,246,.06);border:2px dashed rgba(59,130,246,.18);}
  canvas{display:block;height:240px !important;max-height:360px;}
</style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 font-sans text-gray-800">
<div class="flex min-h-screen">
  <aside id="sidebar" class="sidebar fixed top-0 left-0 w-64 bg-gradient-to-b from-gray-800 to-gray-900 text-white h-full p-6 z-30 md:translate-x-0 sidebar-hidden">
    <h3 class="text-xl font-bold mb-6 text-center">Mi Progreso</h3>
    <nav class="space-y-2 text-sm">
      <a href="#dashboard" data-section="dashboard" class="block py-2 px-3 rounded hover:bg-gray-700">üìä Dashboard</a>
      <a href="#registro-pesos" data-section="registro-pesos" class="block py-2 px-3 rounded hover:bg-gray-700">üèãÔ∏è Registro Pesos</a>
      <a href="#registro-cardio" data-section="registro-cardio" class="block py-2 px-3 rounded hover:bg-gray-700">üèÉ Registro Cardio</a>
      <a href="#pautas-dieta" data-section="pautas-dieta" class="block py-2 px-3 rounded hover:bg-gray-700">ü•ó Pautas Dieta</a>
    </nav>
  </aside>

  <main class="flex-1 ml-0 md:ml-64 p-6">
    <button id="btn-menu" class="md:hidden mb-4 p-3 bg-blue-600 text-white rounded-lg">‚ò∞ Men√∫</button>

    <section id="dashboard" class="section active">
      <h1 class="text-3xl font-bold text-center mb-6">Mi Dashboard</h1>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="card bg-white p-6 rounded-xl shadow">
          <h2 class="text-lg font-semibold mb-4">Progreso General</h2>
          <div class="flex items-center justify-center">
            <div class="relative w-28 h-28">
              <svg viewBox="0 0 100 100" class="w-28 h-28 -rotate-90">
                <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"></circle>
                <circle id="progress-circle" cx="50" cy="50" r="40" stroke="#3b82f6" stroke-width="8" fill="none" stroke-linecap="round" stroke-dasharray="0 251"></circle>
              </svg>
              <div class="absolute inset-0 flex items-center justify-center">
                <span id="progress-percentage" class="text-xl font-bold text-blue-600">0%</span>
              </div>
            </div>
          </div>
          <p id="days-elapsed" class="text-center text-sm text-gray-600 mt-3">D√≠a 1 de 42</p>
        </div>

        <div class="card bg-white p-6 rounded-xl shadow">
          <h2 class="text-lg font-semibold mb-4">Estado Actual</h2>
          <div class="space-y-3">
            <div class="flex justify-between"><span class="text-sm text-gray-600">Peso</span><span id="estado-peso-display" class="font-bold">85.0 kg</span></div>
            <div class="flex justify-between"><span class="text-sm text-gray-600">Cintura</span><span id="estado-cintura-display" class="font-bold">? cm</span></div>
            <div class="w-full bg-gray-200 rounded-full h-2 mt-3"><div id="peso-progress-bar" class="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full" style="width:0%"></div></div>
          </div>
        </div>

        <div class="card bg-white p-6 rounded-xl shadow">
          <h2 class="text-lg font-semibold mb-4">To-Do Hoy</h2>
          <div id="todo-list" class="space-y-3"></div>
          <div class="mt-3">
            <div class="flex justify-between"><span class="text-sm text-gray-600">Completado</span><span id="adherencia-porcentaje" class="font-bold text-green-600">0%</span></div>
            <div class="w-full bg-gray-200 rounded-full h-3 mt-2"><div id="adherencia-bar" class="bg-gradient-to-r from-green-500 to-green-600 h-3 rounded-full" style="width:0%"></div></div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="card bg-white p-6 rounded-xl shadow" style="min-height:240px">
          <h3 class="font-semibold mb-3">Evoluci√≥n del Peso</h3>
          <canvas id="peso-chart" height="240"></canvas>
        </div>
        <div class="card bg-white p-6 rounded-xl shadow" style="min-height:240px">
          <h3 class="font-semibold mb-3">Adherencia Semanal</h3>
          <canvas id="adherencia-chart" height="240"></canvas>
        </div>
      </div>

      <div class="card bg-white p-6 rounded-xl shadow mb-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold">Planificaci√≥n Semanal</h3>
          <button id="reset-plan" class="px-3 py-1 bg-gray-200 rounded">üîÑ Reset</button>
        </div>
        <div id="calendar-semanal" class="grid grid-cols-1 md:grid-cols-7 gap-3"></div>
        <p class="text-xs text-gray-500 mt-3">Arrastra actividades. Colores: üîµ Pull ¬∑ üü¢ Push ¬∑ üü° Piernas ¬∑ üî¥ Cardio ¬∑ ‚ö™ Descanso</p>
      </div>
    </section>

    <section id="registro-pesos" class="section">
      <h1 class="text-2xl font-bold mb-4">Registro de Pesos</h1>
      <div class="flex gap-4 mb-4">
        <div>
          <label class="text-sm">Microciclo</label>
          <select id="filtro-microciclo" class="mt-1 p-2 border rounded"><option value="all">Todos</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>Descarga</option></select>
        </div>
        <div>
          <label class="text-sm">D√≠a</label>
          <select id="filtro-dia" class="mt-1 p-2 border rounded"><option value="all">Todos</option></select>
        </div>
      </div>
      <div class="bg-white p-4 rounded shadow mb-6 overflow-x-auto">
        <table id="tabla-pesos" class="min-w-full border">
          <thead><tr class="bg-blue-600 text-white text-sm"><th class="p-2">D√≠a</th><th class="p-2">Ejercicio</th><th class="p-2">Microciclo</th><th class="p-2">Set</th><th class="p-2">Peso</th><th class="p-2">Reps</th><th class="p-2">Rango</th><th class="p-2">Estado</th><th class="p-2">Tips</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="registro-cardio" class="section">
      <h1 class="text-2xl font-bold mb-4">Registro de Cardio</h1>
      <div class="mb-4">
        <label class="text-sm">Microciclo</label>
        <select id="filtro-microciclo-cardio" class="mt-1 p-2 border rounded"><option value="all">Todos</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>Descarga</option></select>
      </div>
      <div class="bg-white p-4 rounded shadow mb-6 overflow-x-auto">
        <table id="tabla-cardio" class="min-w-full border">
          <thead><tr class="bg-blue-600 text-white text-sm"><th class="p-2">Fecha</th><th class="p-2">Microciclo</th><th class="p-2">Sesi√≥n</th><th class="p-2">Planificado</th><th class="p-2">Realizado (km)</th><th class="p-2">Tiempo (min)</th><th class="p-2">Estado</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="pautas-dieta" class="section">
      <h1 class="text-2xl font-bold mb-4">Pautas de Dieta</h1>
      <div class="bg-white p-4 rounded shadow mb-6">
        <form id="form-dieta" class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <input type="date" id="fecha-dieta" value="2025-08-11" class="p-2 border rounded" />
          <input type="number" id="calorias-dieta" placeholder="Calor√≠as" class="p-2 border rounded" />
          <input type="number" id="proteinas-dieta" placeholder="Prote√≠nas (g)" class="p-2 border rounded" />
          <input type="number" id="carbos-dieta" placeholder="Carbohidratos (g)" class="p-2 border rounded" />
          <input type="number" id="grasas-dieta" placeholder="Grasas (g)" class="p-2 border rounded" />
          <div class="flex items-center gap-2"><input type="checkbox" id="ayuno-dieta"><label>Ayuno 16/8</label></div>
          <div class="md:col-span-3 flex gap-2">
            <button type="button" id="btn-guardar-dieta" class="bg-blue-600 text-white px-4 py-2 rounded">Guardar Dieta</button>
            <button type="button" id="btn-export" class="bg-gray-200 px-4 py-2 rounded">Export JSON</button>
          </div>
        </form>
      </div>
      <div class="bg-white p-4 rounded shadow overflow-x-auto">
        <table id="tabla-dieta" class="min-w-full border">
          <thead><tr class="bg-blue-600 text-white text-sm"><th class="p-2">Fecha</th><th class="p-2">Calor√≠as</th><th class="p-2">Prote√≠nas</th><th class="p-2">Carbos</th><th class="p-2">Grasas</th><th class="p-2">Ayuno</th><th class="p-2">Estado</th><th class="p-2">Feedback</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<!-- Modales -->
<div id="modal-progresion" class="hidden fixed inset-0 z-40 bg-black bg-opacity-50 items-center justify-center">
  <div class="bg-white p-6 rounded max-w-xl mx-4">
    <h3 class="font-semibold mb-2">Progresi√≥n por Microciclos</h3>
    <ul class="text-sm space-y-1">
      <li><strong>Microciclo 1</strong>: T√©cnica, RIR 3.</li>
      <li><strong>2</strong>: +5-10% pesos, RIR 2-3.</li>
      <li><strong>3</strong>: Intensidad, benchmark press 30kg.</li>
      <li><strong>4</strong>: Adaptaci√≥n.</li>
      <li><strong>5</strong>: Pico.</li>
      <li><strong>Descarga</strong>: Volumen bajo (~50%).</li>
    </ul>
    <div class="mt-4 text-right"><button id="close-prog" class="px-3 py-1 bg-blue-600 text-white rounded">Cerrar</button></div>
  </div>
</div>

<div id="modal-dieta" class="hidden fixed inset-0 z-40 bg-black bg-opacity-50 items-center justify-center">
  <div class="bg-white p-6 rounded max-w-xl mx-4">
    <h3 class="font-semibold mb-2">Indicaciones de Dieta</h3>
    <p class="text-sm">~1800 kcal/d√≠a, prote√≠nas 150-185 g. Refeed cada 2 semanas si fatiga. Hidrataci√≥n 3L/d√≠a. Creatina 5g opc.</p>
    <div class="mt-4 text-right"><button id="close-dieta" class="px-3 py-1 bg-blue-600 text-white rounded">Cerrar</button></div>
  </div>
</div>



<script>
/* data (mesociclo completo kept) */
const mesociclo = {
  'D√≠a 1: Pull': [
    { ejercicio: 'Bent over rows con mancuernas', sets: [{ tipo: 'Top', peso: 30, reps: '8-10' }, { tipo: 'Resto', peso: 25, reps: '10-12', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Jal√≥n polea alta pecho apoyado unilateral', sets: [{ tipo: 'Normal', peso: 10, reps: '8-10', count: 3 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Remo polea pecho apoyado unilateral', sets: [{ tipo: 'Normal', peso: 10, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Face pull polea alta boca arriba', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Low cable rear delt row', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Curl alterno con mancuernas', sets: [{ tipo: 'Top', peso: 10, reps: '6-8' }, { tipo: 'Resto', peso: 10, reps: '10-12', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Curl bayesian en polea', sets: [{ tipo: 'Normal', peso: 10, reps: '10-12', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Crunch abdominal en polea alta', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] }
  ],
  'D√≠a 2: Push': [
    { ejercicio: 'Press inclinado multipower 45¬∫', sets: [{ tipo: 'Top', peso: 35, reps: '5-7' }, { tipo: 'Resto', peso: 30, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Contractora pectoral m√°quina inclinada', sets: [{ tipo: 'Normal', peso: 10, reps: '10-12', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Press en m√°quina', sets: [{ tipo: 'Normal', peso: 10, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Elevaciones laterales polea con mu√±equera', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Elevaciones laterales mancuernas', sets: [{ tipo: 'Normal', peso: 10, reps: '>15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Press franc√©s mancuernas', sets: [{ tipo: 'Top', peso: 10, reps: '8-10' }, { tipo: 'Resto', peso: 10, reps: '10-12', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Extensi√≥n tr√≠ceps katana polea baja', sets: [{ tipo: 'Normal', peso: 10, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Crunch abdominal en polea alta', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] }
  ],
  'D√≠a 3: Piernas': [
    { ejercicio: 'Aducci√≥n de cadera en m√°quina', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Prensa 45¬∫', sets: [{ tipo: 'Top', peso: 10, reps: '6-8' }, { tipo: 'Resto', peso: 10, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Sentadilla b√∫lgara (√©nfasis gl√∫teo)', sets: [{ tipo: 'Top', peso: 20, reps: '6-8' }, { tipo: 'Resto', peso: 15, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Curl femoral en m√°quina', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Extensi√≥n de rodilla en m√°quina', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Elevaciones de talones en m√°quina', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] }
  ],
  'D√≠a 4: Pull': [
    { ejercicio: 'Bent over rows con mancuernas', sets: [{ tipo: 'Top', peso: 30, reps: '6-8' }, { tipo: 'Resto', peso: 25, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Jal√≥n polea alta pecho apoyado unilateral', sets: [{ tipo: 'Normal', peso: 10, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'M√°quina remo espalda alta', sets: [{ tipo: 'Normal', peso: 10, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Pullover polea alta rodillas banco 60¬∫', sets: [{ tipo: 'Normal', peso: 10, reps: '8-12', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Face pull polea alta boca arriba', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Low cable rear delt row', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Curl barra Z', sets: [{ tipo: 'Top', peso: 10, reps: '6-8' }, { tipo: 'Resto', peso: 10, reps: '10-12', count: 1 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Curl bayesian en polea', sets: [{ tipo: 'Normal', peso: 10, reps: '10-12', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Ab wheel', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] }
  ],
  'D√≠a 5: Push': [
    { ejercicio: 'Press inclinado multipower 30¬∫', sets: [{ tipo: 'Top', peso: 35, reps: '6-8' }, { tipo: 'Resto', peso: 30, reps: '8-10', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Contractora pectoral en m√°quina', sets: [{ tipo: 'Normal', peso: 10, reps: '10-12', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Press militar mancuernas banco inclinado', sets: [{ tipo: 'Top', peso: 10, reps: '7-9' }, { tipo: 'Resto', peso: 10, reps: '9-11', count: 1 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Elevaciones laterales polea con mu√±equera', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 3 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Elevaciones laterales mancuernas', sets: [{ tipo: 'Normal', peso: 10, reps: '>15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Press franc√©s barra Z 30¬∫', sets: [{ tipo: 'Top', peso: 10, reps: '8-10' }, { tipo: 'Resto', peso: 10, reps: '10-12', count: 1 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Extensi√≥n tr√≠ceps katana polea baja', sets: [{ tipo: 'Normal', peso: 10, reps: '8-10', count: 3 }], microciclo: [1,2,3,4,5,'Descarga'] },
    { ejercicio: 'Crunch abdominal en polea alta', sets: [{ tipo: 'Normal', peso: 10, reps: '12-15', count: 2 }], microciclo: [1,2,3,4,5,'Descarga'] }
  ],
  'Cardio': [
    { microciclo: 1, sesiones: [
        { id: 1, plan: '25 min (15 min trote 6:30-7:00 min/km + 5 min intervalos [1 min 5:30 / 1 min caminando x3] + 5 min calentamiento/enfriamiento)', km: 3.5 },
        { id: 2, plan: '25 min (igual)', km: 3.5 },
        { id: 3, plan: '25 min (igual)', km: 3.5 }
    ]},
    { microciclo: 2, sesiones: [
        { id: 1, plan: '25 min (15 min trote 6:15-6:45)', km: 3.5 }, { id: 2, plan: '25 min', km: 3.5 }, { id: 3, plan: '25 min', km: 3.5 }
    ]},
    { microciclo: 3, sesiones: [
        { id: 1, plan: '25 min (intervalos 5:00)', km: 3.5 }, { id: 2, plan: '25 min', km: 3.5 }, { id: 3, plan: '25 min', km: 3.5 }
    ]},
    { microciclo: 4, sesiones: [
        { id: 1, plan: '27 min (15 min trote 6:00-6:30 + intervalos)', km: 4 }, { id: 2, plan: '27 min', km: 4 }, { id: 3, plan: '27 min', km: 4 }
    ]},
    { microciclo: 5, sesiones: [
        { id: 1, plan: '30 min (intervalos 4:45)', km: 4.5 }, { id: 2, plan: '30 min', km: 4.5 }, { id: 3, plan: '30 min', km: 4.5 }
    ]},
    { microciclo: 'Descarga', sesiones: [
        { id: 1, plan: '20 min trote ligero', km: 3 }, { id: 2, plan: '20 min', km: 3 }, { id: 3, plan: '20 min', km: 3 }
    ]}
  ]
};


/* minimal state helpers */
let estado = JSON.parse(localStorage.getItem('estado')) || [];
let pesos = JSON.parse(localStorage.getItem('pesos')) || [];
let cardio = JSON.parse(localStorage.getItem('cardio')) || [];
let dieta = JSON.parse(localStorage.getItem('dieta')) || [];
let planSemanal = JSON.parse(localStorage.getItem('planSemanal')) || [
  { dia: 'Lunes', tareas: ['D√≠a 1: Pull', 'Cardio'] },
  { dia: 'Martes', tareas: ['D√≠a 2: Push', 'Cardio'] },
  { dia: 'Mi√©rcoles', tareas: ['D√≠a 3: Piernas'] },
  { dia: 'Jueves', tareas: ['Descanso'] },
  { dia: 'Viernes', tareas: ['D√≠a 4: Pull', 'Cardio'] },
  { dia: 'S√°bado', tareas: ['D√≠a 5: Push'] },
  { dia: 'Domingo', tareas: ['Descanso'] }
];
let adherenciaDiaria = JSON.parse(localStorage.getItem('adherenciaDiaria')) || {};

const q=(s,d=document)=>d.querySelector(s), qa=(s,d=document)=>Array.from(d.querySelectorAll(s));
const todayISO=()=>new Date().toISOString().split('T')[0];
const daysName=['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
const getTodayName=(d=new Date())=>daysName[d.getDay()];
const saveAll=()=>{ localStorage.setItem('estado',JSON.stringify(estado)); localStorage.setItem('pesos',JSON.stringify(pesos)); localStorage.setItem('cardio',JSON.stringify(cardio)); localStorage.setItem('dieta',JSON.stringify(dieta)); localStorage.setItem('planSemanal',JSON.stringify(planSemanal)); localStorage.setItem('adherenciaDiaria',JSON.stringify(adherenciaDiaria)); };

/* UI wiring */
document.getElementById('btn-menu').addEventListener('click',()=>document.getElementById('sidebar').classList.toggle('sidebar-hidden'));
window.addEventListener('DOMContentLoaded',()=>{ if(window.innerWidth>=768) document.getElementById('sidebar').classList.remove('sidebar-hidden'); });

qa('a[data-section]').forEach(a=>a.addEventListener('click',e=>{
  e.preventDefault(); showSection(a.dataset.section);
  if(window.innerWidth<768) document.getElementById('sidebar').classList.add('sidebar-hidden');
}));
function showSection(id){
  qa('.section').forEach(s=>s.classList.remove('active')); q('#'+id).classList.add('active'); window.scrollTo({top:0,behavior:'smooth'});
  if(id==='registro-pesos') inicializarTablaPesos(); if(id==='registro-cardio') inicializarTablaCardio(); if(id==='pautas-dieta') inicializarTablaDieta();
}

/* progress/adherence */
function actualizarProgresoGeneral(){
  const inicio=new Date('2025-08-11'); const diasTot=42;
  const diasTrans=Math.min(Math.floor((new Date()-inicio)/(1000*60*60*24))+1,diasTot);
  q('#days-elapsed').textContent=`D√≠a ${diasTrans} de ${diasTot}`;
  const ultimo=estado.length?estado[estado.length-1]:{peso:85,cintura:null};
  const pIni=85,pObj=80;
  const pTemp=(diasTrans/diasTot)*100; const pPeso=Math.min(((pIni-ultimo.peso)/(pIni-pObj))*100,100);
  const pTotal=Math.max(pTemp*0.3 + pPeso*0.7,0);
  const circ=2*Math.PI*40; q('#progress-circle').style.strokeDasharray=`${(pTotal/100)*circ} ${circ}`;
  q('#progress-percentage').textContent=`${Math.round(pTotal)}%`; q('#estado-peso-display').textContent=`${ultimo.peso.toFixed(1)} kg`; q('#estado-cintura-display').textContent=ultimo.cintura?`${ultimo.cintura.toFixed(1)} cm`:'? cm';
  q('#peso-progress-bar').style.width=`${Math.max(0,pPeso)}%`;
}

/* todo list (includes pesaje diario) */
function actualizarTodoList(){
  const day = todayISO(); const planHoy=planSemanal.find(p=>p.dia===getTodayName())?.tareas||[];
  const container=q('#todo-list'); container.innerHTML='';
  const items=[];
  if(planHoy.some(t=>t.includes('Pull')||t.includes('Push')||t.includes('Piernas'))) items.push({id:'pesos',label:'Entreno de Pesos'});
  if(planHoy.includes('Cardio')) items.push({id:'cardio',label:'Cardio'});
  items.push({id:'dieta',label:'Dieta (~1800 kcal)'}); items.push({id:'ayuno',label:'Ayuno 16/8'});
  // pesaje diario UI
  const pesoHoy = (estado.find(e=>e.fecha===day)||{}).peso || '';
  const pesoDiv = document.createElement('div'); pesoDiv.className='space-y-2';
  pesoDiv.innerHTML = `<label class="text-sm">Pesaje diario</label>
    <div class="flex gap-2 items-center">
      <input id="todo-pesaje-input" type="number" step="0.1" placeholder="kg" value="${pesoHoy}" class="p-2 border rounded w-28">
      <button id="todo-pesaje-save" class="px-3 py-1 bg-blue-600 text-white rounded">Guardar</button>
      <span id="todo-pesaje-status" class="text-sm ${pesoHoy? 'text-green-600':'text-gray-500'}">${pesoHoy? 'Registrado':''}</span>
    </div>`;
  container.appendChild(pesoDiv);
  q('#todo-pesaje-save').addEventListener('click',()=>{ const v=parseFloat(q('#todo-pesaje-input').value); guardarPesajeHoy(v); });

  items.forEach(t=>{
    const div=document.createElement('div'); div.className='flex items-center justify-between';
    const checked = !!(adherenciaDiaria[day]&&adherenciaDiaria[day][t.id]);
    div.innerHTML = `<label class="flex items-center gap-2"><input type="checkbox" id="todo-${t.id}" ${checked?'checked':''}> <span class="text-sm">${t.label}</span></label>`;
    container.appendChild(div);
    q(`#todo-${t.id}`).addEventListener('change', e=>{ actualizarAdherenciaTask(t.id, e.target.checked); });
  });

  const total = container.querySelectorAll('input[type="checkbox"]').length + 1; // +1 por pesaje
  let done = 0; container.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ if(cb.checked) done++; });
  if(q('#todo-pesaje-input') && q('#todo-pesaje-input').value) done++;
  const pct = total? Math.round((done/total)*100) : 0;
  q('#adherencia-porcentaje').textContent = `${pct}%`; q('#adherencia-bar').style.width = `${pct}%`;
}
function actualizarAdherenciaTask(id,val){
  const d=todayISO(); if(!adherenciaDiaria[d]) adherenciaDiaria[d]={};
  adherenciaDiaria[d][id]=!!val; saveAll(); actualizarTodoList();
}

/* guardar pesaje diario */
function guardarPesajeHoy(value){
  if(!value || isNaN(value) || value<=0){ alert('Ingresa un peso v√°lido'); return; }
  const fecha=todayISO();
  estado = estado.filter(e=>e.fecha!==fecha);
  estado.push({fecha, peso: parseFloat(value), cintura: null});
  estado.sort((a,b)=>new Date(a.fecha)-new Date(b.fecha));
  saveAll();
  // mark pesaje in adherence so it's tracked today
  if(!adherenciaDiaria[fecha]) adherenciaDiaria[fecha]={};
  adherenciaDiaria[fecha].pesaje = true;
  saveAll();
  actualizarProgresoGeneral(); actualizarGraficoPeso(); actualizarTodoList();
}

/* adherence scoring uses training/cardio/dieta/ayuno; pesaje is tracked separately and saved to estado */
function calcularAdherencia(fecha=todayISO()){
  const planHoy=planSemanal.find(p=>p.dia===getTodayName())?.tareas||[]; const a=adherenciaDiaria[fecha]||{};
  let score=0; if(planHoy.some(t=>t.includes('Pull')||t.includes('Push')||t.includes('Piernas'))) score += a.pesos?30:0;
  if(planHoy.includes('Cardio')) score += a.cardio?20:0; score += a.dieta?40:0; score += a.ayuno?10:0; return score;
}

/* Charts (destroy/create safe) */
let pesoChart=null, adherenciaChart=null;
function crearGraficoPeso(){
  if(pesoChart){ try{ pesoChart.destroy(); }catch(e){} pesoChart=null; }
  const ctx=q('#peso-chart').getContext('2d');
  pesoChart = new Chart(ctx,{ type:'line', data:{ labels:[], datasets:[{label:'Peso', data:[], borderColor:'#3b82f6', backgroundColor:'rgba(59,130,246,.08)', tension:.3, fill:true}]}, options:{responsive:true, maintainAspectRatio:false} });
  actualizarGraficoPeso();
}
function actualizarGraficoPeso(){
  if(!pesoChart) return crearGraficoPeso();
  const labels = estado.slice(-12).map(e=>new Date(e.fecha).toLocaleDateString());
  const data = estado.slice(-12).map(e=>e.peso);
  pesoChart.data.labels = labels.length?labels:['Inicio']; pesoChart.data.datasets[0].data = data.length?data:[85]; pesoChart.update();
}
function crearGraficoAdherencia(){ if(adherenciaChart){ try{ adherenciaChart.destroy(); }catch(e){} adherenciaChart=null; } const ctx=q('#adherencia-chart').getContext('2d');
  adherenciaChart = new Chart(ctx,{ type:'bar', data:{ labels:[], datasets:[{label:'Adherencia (%)', data:[], borderRadius:4, backgroundColor:[]} ]}, options:{responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true,max:100}}} });
  actualizarGraficoAdherencia();
}
function actualizarGraficoAdherencia(){
  if(!adherenciaChart) return crearGraficoAdherencia();
  const labels=[]; const data=[];
  for(let i=6;i>=0;i--){ const d=new Date(); d.setDate(d.getDate()-i); const iso=d.toISOString().split('T')[0]; labels.push(daysName[d.getDay()].slice(0,3)); const a=adherenciaDiaria[iso]||{}; const completed=(a.pesos?1:0)+(a.cardio?1:0)+(a.dieta?1:0)+(a.ayuno?1:0); data.push(Math.round((completed/4)*100)); }
  adherenciaChart.data.labels=labels; adherenciaChart.data.datasets[0].data=data; adherenciaChart.data.datasets[0].backgroundColor = data.map(d => d>=75? '#10b981': d>=50? '#f59e0b':'#ef4444'); adherenciaChart.update();
}

/* Calendar drag/drop */
function actualizarCalendarioSemanal(){
  const calendar=q('#calendar-semanal'); calendar.innerHTML='';
  planSemanal.forEach((day,idx)=>{ const isToday=day.dia===getTodayName(); const card=document.createElement('div'); card.className=`p-3 rounded-xl ${isToday?'bg-blue-50 border-blue-200':'bg-white border-gray-200'} card`;
    card.innerHTML=`<div class="font-semibold text-center mb-2">${day.dia}${isToday?'<div class="text-xs text-blue-600">HOY</div>':''}</div><div id="slot-${idx}" class="min-h-[80px] space-y-2" ondragover="allowDrop(event)" ondrop="drop(event,${idx})"></div>`; calendar.appendChild(card);
    const slot=q(`#slot-${idx}`);
    day.tareas.forEach((t,ti)=>{ const el=document.createElement('div'); el.className=`p-2 rounded text-xs font-medium ${t==='Descanso'?'bg-gray-200': t.includes('Pull')?'bg-blue-200': t.includes('Push')?'bg-green-200': t.includes('Piernas')?'bg-yellow-200':'bg-red-200'} draggable`; el.draggable=true; el.id=`task-${idx}-${ti}`; el.ondragstart=e=>e.dataTransfer.setData('application/json',JSON.stringify({fromDay:idx,taskIndex:ti})); el.textContent=t; slot.appendChild(el); });
  });
}
function allowDrop(e){ e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
function drop(e,toDay){ e.preventDefault(); e.currentTarget.classList.remove('drag-over'); try{ const {fromDay,taskIndex}=JSON.parse(e.dataTransfer.getData('application/json')); if(fromDay===toDay) return; const task=planSemanal[fromDay].tareas.splice(taskIndex,1)[0]; planSemanal[toDay].tareas.push(task); saveAll(); actualizarCalendarioSemanal(); actualizarTodoList(); }catch(err){console.warn(err);} }

/* Pesos table (filters fixed) */
function inicializarTablaPesos(){
  const microcicloFiltro=q('#filtro-microciclo').value || 'all';
  const filtroDia=q('#filtro-dia'); filtroDia.innerHTML = '<option value="all">Todos</option>' + Object.keys(mesociclo).filter(k=>k!=='Cardio').map(k=>`<option value="${k}">${k}</option>`).join('');
  const diaFiltro=filtroDia.value;
  const tbody=q('#tabla-pesos tbody'); tbody.innerHTML='';
  Object.keys(mesociclo).filter(k=>k!=='Cardio' && (diaFiltro==='all' || k===diaFiltro)).forEach(dia=>{
    mesociclo[dia].forEach(ej=>{
      const mcArray = ej.microciclo || [1,2,3,4,5,'Descarga'];
      mcArray.filter(m => microcicloFiltro==='all' || String(m)===String(microcicloFiltro)).forEach(mVal=>{
        ej.sets.forEach((set,setIndex)=>{
          const count=set.count||1;
          for(let i=0;i<count;i++){
            const setId = `${set.tipo}${set.count && i>0 ? ` ${i+1}` : ''}`;
            const sugerido = set.peso || 0;
            const existing = pesos.find(p=>p.dia===dia && p.ejercicio===ej.ejercicio && String(p.microciclo)===String(mVal) && p.tipo===set.tipo && p.setIndex===i);
            const pesoVal = existing?existing.peso:sugerido;
            const reps = existing?existing.reps:'';
            const row = tbody.insertRow();
            row.innerHTML = `<td class="p-2 border text-sm">${dia}</td><td class="p-2 border text-sm">${ej.ejercicio}</td><td class="p-2 border text-sm">${mVal}</td><td class="p-2 border text-sm">${setId}</td>
              <td class="p-2 border"><input type="number" class="w-20 p-1 border rounded" value="${pesoVal}" onchange="guardarPesoReps(this,'${dia}','${ej.ejercicio}',${JSON.stringify(mVal)},'${set.tipo}',${i},'peso')"></td>
              <td class="p-2 border"><input type="number" class="w-20 p-1 border rounded" value="${reps}" onchange="guardarPesoReps(this,'${dia}','${ej.ejercicio}',${JSON.stringify(mVal)},'${set.tipo}',${i},'reps')"></td>
              <td class="p-2 border text-sm">${set.reps}</td><td class="p-2 border text-sm bg-gray-100"></td><td class="p-2 border text-sm tips"></td>`;
          }
        });
      });
    });
  });
}

/* guardar peso/reps */
window.guardarPesoReps = function(input,dia,ejercicio,microciclo,tipo,setIndex,campo){
  const row=input.closest('tr'); const peso=parseFloat(row.cells[4].querySelector('input').value)||0; const reps=parseInt(row.cells[5].querySelector('input').value)||0;
  if(campo==='peso' && peso<=0){ alert('Peso > 0'); return; }
  pesos = pesos.filter(p=>!(p.dia===dia && p.ejercicio===ejercicio && String(p.microciclo)===String(microciclo) && p.tipo===tipo && p.setIndex===setIndex));
  if(peso>0||reps>0) pesos.push({dia,ejercicio,microciclo,tipo,setIndex,peso,reps,rango:row.cells[6].textContent,fecha:todayISO()});
  saveAll(); row.cells[7].className = 'p-2 border text-sm '+(reps>0? 'bg-green-500':'bg-yellow-500'); actualizarTipsPesosRow(row,row.cells[6].textContent,reps,peso,ejercicio,microciclo); actualizarAdherenciaTask('pesos', reps>0);
};

/* Cardio table (filter fixed) */
function inicializarTablaCardio(){
  const filtro = q('#filtro-microciclo-cardio').value || 'all'; const tbody=q('#tabla-cardio tbody'); tbody.innerHTML='';
  mesociclo.Cardio.filter(c=> filtro==='all' || String(c.microciclo)===String(filtro)).forEach(c=>{
    c.sesiones.forEach(s=>{
      const existing = cardio.find(r=>String(r.microciclo)===String(c.microciclo) && r.sesionId===s.id && r.fecha===todayISO());
      const row = tbody.insertRow();
      row.innerHTML = `<td class="p-2 border"><input type="date" class="p-1 border rounded" value="${existing?.fecha||todayISO()}"></td>
        <td class="p-2 border text-sm">${c.microciclo}</td><td class="p-2 border text-sm">Sesi√≥n ${s.id}</td><td class="p-2 border text-sm">${s.plan}</td>
        <td class="p-2 border"><input type="number" class="w-20 p-1 border rounded" value="${existing?.km||''}" onchange="guardarCardio(this,${c.microciclo},${s.id})"></td>
        <td class="p-2 border"><input type="number" class="w-20 p-1 border rounded" value="${existing?.tiempo||''}" onchange="guardarCardio(this,${c.microciclo},${s.id})"></td>
        <td class="p-2 border text-sm ${existing && existing.ritmo && existing.km>=s.km ? 'bg-green-500':'bg-gray-100'}"></td>`;
    });
  });
}
window.guardarCardio = function(input,microciclo,sesionId){
  const row=input.closest('tr'); const fecha=row.cells[0].querySelector('input').value||todayISO(); const km=parseFloat(row.cells[4].querySelector('input').value)||0; const tiempo=parseInt(row.cells[5].querySelector('input').value)||0;
  if(km<=0||tiempo<=0){ alert('KM y tiempo > 0'); return; }
  const ritmo = tiempo/km; cardio = cardio.filter(c=>!(String(c.microciclo)===String(microciclo) && c.sesionId===sesionId && c.fecha===fecha)); cardio.push({fecha,microciclo,sesionId,km,tiempo,ritmo,calorias:Math.round(tiempo*(ritmo>6?10:12))});
  saveAll(); actualizarAdherenciaTask('cardio', km>0 && tiempo>0); inicializarTablaCardio();
};

/* Dieta simple */
q('#btn-guardar-dieta').addEventListener('click', ()=>{ const f=q('#fecha-dieta').value||todayISO(), c=parseInt(q('#calorias-dieta').value)||0, p=parseInt(q('#proteinas-dieta').value)||0, carb=parseInt(q('#carbos-dieta').value)||0, g=parseInt(q('#grasas-dieta').value)||0, ay=!!q('#ayuno-dieta').checked; if(c<=0||p<=0||carb<=0||g<=0){alert('Introduce valores');return;} dieta=dieta.filter(d=>d.fecha!==f); dieta.push({fecha:f,calorias:c,proteinas:p,carbos:carb,grasas:g,ayuno:ay}); saveAll(); actualizarAdherenciaTask('dieta', c>=1700 && c<=1900 && p>=150 && p<=185); inicializarTablaDieta(); });
function inicializarTablaDieta(){ const tbody=q('#tabla-dieta tbody'); tbody.innerHTML=''; dieta.forEach(reg=>{ const estadoClass = reg.calorias>=1700 && reg.calorias<=1900 && reg.proteinas>=150 && reg.proteinas<=185 ? 'bg-green-500' : 'bg-yellow-500'; const fb=[]; if(reg.calorias>=1700 && reg.calorias<=1900) fb.push('‚úÖ Calor√≠as en rango'); else if(reg.calorias<1700) fb.push('‚ö†Ô∏è Calor√≠as bajas'); else fb.push('‚ö†Ô∏è Calor√≠as altas'); if(reg.proteinas>=150 && reg.proteinas<=185) fb.push('‚úÖ Prote√≠nas ok'); else fb.push('‚ö†Ô∏è Ajustar prote√≠nas'); const tr=tbody.insertRow(); tr.innerHTML=`<td class="p-2 border text-sm">${reg.fecha}</td><td class="p-2 border">${reg.calorias}</td><td class="p-2 border">${reg.proteinas}</td><td class="p-2 border">${reg.carbos}</td><td class="p-2 border">${reg.grasas}</td><td class="p-2 border">${reg.ayuno?'16/8':'No'}</td><td class="p-2 border ${estadoClass}"></td><td class="p-2 border text-xs">${fb.map(f=>`<p>${f}</p>`).join('')}</td>`; }); }

/* init */
document.addEventListener('DOMContentLoaded',()=>{
  // attach filters
  q('#filtro-microciclo').addEventListener('change', inicializarTablaPesos);
  q('#filtro-dia').addEventListener('change', inicializarTablaPesos);
  q('#filtro-microciclo-cardio').addEventListener('change', inicializarTablaCardio);
  // initial render
  actualizarProgresoGeneral(); actualizarTodoList(); crearGraficoPeso(); crearGraficoAdherencia(); actualizarCalendarioSemanal(); inicializarTablaPesos(); inicializarTablaCardio(); inicializarTablaDieta();
  // periodic light refresh
  setInterval(()=>{ actualizarProgresoGeneral(); actualizarTodoList(); actualizarGraficoAdherencia(); },30000);
  // export
  q('#btn-export').addEventListener('click',()=>{ const data={estado,pesos,cardio,dieta,planSemanal,adherenciaDiaria}; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='entrenamiento.json'; a.click(); URL.revokeObjectURL(a.href); });
});

/* cleanup visuals */
document.addEventListener('dragend',e=>{ if(e.target) e.target.style.opacity='1'; });
document.addEventListener('dragleave',e=>{ if(e.target) e.target.classList.remove('drag-over'); });
</script>
</body>
</html>


